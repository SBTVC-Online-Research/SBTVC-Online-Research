        <!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ระบบอัปโหลดผลงานวิจัย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh; /* ทำให้ body สูงเต็มหน้าจอ */
            display: flex;
            flex-direction: column;
        }
        main {
            flex: 1; /* ทำให้ main ขยายเต็มพื้นที่ที่เหลือ */
        }
        .upload-box-file {
            border: 2px dashed hsl(27, 93%, 49%);
            transition: all 0.3s ease;
        }
        .upload-box-file:hover {
            border-color: #db7c0ed5;
            background-color: rgba(231, 134, 23, 0.89);
        }
        .category-item {
            transition: all 0.2s ease;
            border-color: #e0e0e0; /* สีขอบเริ่มต้น */
        }
        .category-item:hover {
            transform: translateY(-2px);
            border-color: #d47a13;
        }
        .category-item.selected {
            border-color: #d47a13;
            background-color: rgb(233, 55, 11);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .message {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            text-align: center;
        }
        .message.success {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .message.error {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
        .message.info {
            background-color: #e0f2fe; /* blue-100 */
            color: #1e40af; /* blue-800 */
        }
        .author-entry {
            align-items: center;
        }
    </style>
</head>
<body>

<header class="bg-gradient-to-r from-orange-600 to-indigo-700 text-white py-6 shadow-lg">
    <div class="container mx-auto px-4">
        <h1 class="text-3xl font-bold">ระบบอัปโหลดผลงานวิจัย</h1>
        <p class="mt-2 text-orange-100">อัปโหลดและจัดการผลงานวิจัยของคุณได้อย่างง่ายดาย</p>
    </div>
</header>

<main class="container mx-auto px-4 py-8">
    <div class="flex justify-end mb-4">
        <a href="index.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            ← กลับหน้าหลัก
        </a>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">อัปโหลดผลงานวิจัยใหม่</h2>
        <form id="research-form">
            <div class="mb-6">
                <label for="title" class="block text-gray-700 font-medium mb-2">ชื่อผลงานวิจัย <span class="text-red-500">*</span></label>
                <input type="text" id="title" name="title" class="w-full px-4 py-2 border rounded-lg focus:ring-orange-500 focus:border-orange-500 outline-none" required>
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2">หมวดหมู่ <span class="text-red-500">*</span></label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="category-item border p-4 rounded-lg text-center cursor-pointer" data-category="survey">สำรวจ</div>
                    <div class="category-item border p-4 rounded-lg text-center cursor-pointer" data-category="theory">ทฤษฎี</div>
                    <div class="category-item border p-4 rounded-lg text-center cursor-pointer" data-category="experiment">ทดลอง</div>
                    <div class="category-item border p-4 rounded-lg text-center cursor-pointer" data-category="invention">ประดิษฐ์</div>
                </div>
                <input type="hidden" id="selected-category" name="category" required>
            </div>

            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="department" class="block text-gray-700 font-medium mb-2">สาขาวิชา <span class="text-red-500">*</span></label>
                    <select id="department" name="department" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500 outline-none" required>
                        <option value="" disabled selected>เลือกสาขาวิชา</option>
                        <option value="computer">คอมพิวเตอร์ธุรกิจ</option>
                        <option value="accounting">การบัญชี</option>
                        <option value="marketing">การตลาด</option>
                        <option value="electronics">อิเล็กทรอนิกส์</option>
                        <option value="mechanics">ช่างยนต์</option>
                    </select>
                </div>
                <div>
                    <label for="field" class="block text-gray-700 font-medium mb-2">สาขางาน <span class="text-red-500">*</span></label>
                    <select id="field" name="field" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500 outline-none" required>
                        <option value="" disabled selected>เลือกสาขางาน</option>
                        <option value="programming">การเขียนโปรแกรม</option>
                        <option value="network">เครือข่าย</option>
                        <option value="web-design">การออกแบบเว็บไซต์</option>
                        <option value="multimedia">มัลติมีเดีย</option>
                    </select>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="year" class="block text-gray-700 font-medium mb-2">ชั้นปี <span class="text-red-500">*</span></label>
                    <select id="year" name="year" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500 outline-none" required>
                        <option value="" disabled selected>เลือกชั้นปี</option>
                        <option>ปวช.1</option><option>ปวช.2</option><option>ปวช.3</option>
                        <option>ปวส.1</option><option>ปวส.2</option>
                    </select>
                </div>
                <div>
                    <label for="academic-year" class="block text-gray-700 font-medium mb-2">ปีการศึกษา <span class="text-red-500">*</span></label>
                    <select id="academic-year" name="academicYear" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500 outline-none" required>
                        <option value="" disabled selected>เลือกปีการศึกษา</option>
                        <option>2567</option><option>2566</option><option>2565</option><option>2564</option><option>2563</option>
                    </select>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2">ชื่อผู้จัดทำ <span class="text-red-500">*</span></label>
                <div id="authors-container">
                    <div class="author-entry flex items-center gap-4 mb-2">
                        <input type="text" name="authors[]" class="flex-1 border rounded-lg px-4 py-2 focus:ring-blue-500 outline-none" placeholder="ชื่อ-นามสกุล" required value="">
                        <button type="button" class="add-author bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition">
                            ＋
                        </button>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label for="advisor" class="block text-gray-700 font-medium mb-2">อาจารย์ที่ปรึกษา <span class="text-red-500">*</span></label>
                <input type="text" id="advisor" name="advisor" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500 outline-none" required>
            </div>

            <div class="mb-6">
                <label for="abstract" class="block text-gray-700 font-medium mb-2">บทคัดย่อ <span class="text-red-500">*</span></label>
                <textarea id="abstract" name="abstract" rows="4" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500 outline-none" required></textarea>
            </div>

            <div class="mb-8">
                <label class="block text-gray-700 font-medium mb-2">อัปโหลดรูปภาพปกผลงาน (ไม่เกิน 5MB) <span class="text-red-500">*</span></label>
                <div class="upload-box-file bg-gray-50 rounded-lg p-8 text-center cursor-pointer">
                    <input type="file" id="cover-image-upload" class="hidden" accept="image/*">
                    <div>
                        <svg class="h-12 w-12 mx-auto text-orange-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/></svg>
                    </div>
                    <p class="font-medium text-gray-700">ลากรูปภาพหรือคลิกเพื่อเลือก</p>
                    <p class="text-sm text-gray-500">รองรับ: JPG, PNG, GIF, WEBP (สูงสุด 5MB/ไฟล์)</p>
                </div>
                <div id="cover-image-preview-container" class="mt-4 hidden border p-4 rounded-lg flex flex-col items-center">
                    <img id="uploaded-image-display" src="" alt="Cover Image Preview" class="max-w-full h-auto rounded-lg mb-2">
                    <p id="image-url-display" class="text-sm text-gray-600 break-all mb-2"></p>
                    <button type="button" id="remove-cover-image" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">ลบรูปภาพปก</button>
                </div>
                <input type="hidden" id="uploaded-image-url" name="coverImageUrl">
                <div id="image-upload-message" class="message hidden"></div>
            </div>

            <div class="mb-8">
                <label class="block text-gray-700 font-medium mb-2">อัปโหลดไฟล์ผลงานวิจัย (PDF/DOCX) <span class="text-red-500">*</span></label>
                <div class="upload-box-file bg-gray-50 rounded-lg p-8 text-center cursor-pointer">
                    <input type="file" id="research-file-upload" class="hidden" multiple accept=".pdf,.docx"> <div>
                        <svg class="h-12 w-12 mx-auto text-orange-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/></svg>
                    </div>
                    <p class="font-medium text-gray-700">ลากไฟล์หรือคลิกเพื่อเลือก</p>
                    <p class="text-sm text-gray-500">รองรับ: PDF, DOCX (สูงสุด 10MB/ไฟล์)</p>
                </div>
                <div id="research-file-list" class="mt-4 space-y-2"></div>
                <input type="hidden" id="uploaded-research-files-url" name="researchFileUrls">
                <div id="file-upload-message" class="message hidden"></div>
            </div>

            <div id="form-message" class="message hidden"></div>
            <div class="flex justify-end">
                <button type="button" id="cancel-btn" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 mr-4 transition">ยกเลิก</button>
                <button type="submit" id="submit-btn" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition">อัปโหลด</button>
            </div>
        </form>
    </div>
</main>

<script>
    // **Cloudinary Configuration**
    // เนื่องจากคุณยืนยันว่าใช้ STVC_preset สำหรับทั้งรูปภาพและไฟล์เอกสาร
    const CLOUDINARY_CLOUD_NAME = 'davuwvefc';
    const CLOUDINARY_UPLOAD_PRESET = 'STVC_preset'; // ใช้ preset เดียวกันตามที่คุณแจ้ง

    // **Google Apps Script Web App URL**
    // **สำคัญ: ต้องอัปเดต URL นี้หลังจาก Deploy Apps Script ใหม่ทุกครั้ง**
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-QTyfdSXqxmqVNoql7uRkoRZuGCHlZOJA-atzZT4ZEnIiLE_92v6dEm6iR3hBOzkp/exec';
    // เลือกหมวดหมู่
    const categoryItems = document.querySelectorAll('.category-item');
    const selectedCategoryInput = document.getElementById('selected-category');

    categoryItems.forEach(item => {
        item.addEventListener('click', () => {
            categoryItems.forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            selectedCategoryInput.value = item.dataset.category;
            hideFormMessage();
            updateSubmitButtonState(); // อัปเดตสถานะปุ่มเมื่อเลือกหมวดหมู่
        });
    });

    // เพิ่ม/ลบรายชื่อผู้จัดทำ
    const authorsContainer = document.getElementById('authors-container');

    function createAuthorInput(value = '') {
        const newAuthorDiv = document.createElement('div');
        newAuthorDiv.className = 'author-entry flex items-center gap-4 mb-2';
        newAuthorDiv.innerHTML = `
            <input type="text" name="authors[]" class="flex-1 border rounded-lg px-4 py-2 focus:ring-blue-500 outline-none" placeholder="ชื่อ-นามสกุล" required value="${value}">
            <button type="button" class="remove-author bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition">－</button>
        `;
        return newAuthorDiv;
    }

    // สร้างปุ่มเพิ่มผู้แต่ง
    function createAddButton() {
        const addButton = document.createElement('button');
        addButton.type = 'button';
        addButton.className = 'add-author bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition';
        addButton.textContent = '＋';
        return addButton;
    }

    // สร้างปุ่มลบผู้แต่ง
    function createRemoveButton() {
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'remove-author bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition';
        removeButton.textContent = '－';
        return removeButton;
    }

    // เมื่อโหลดหน้าเว็บ ให้แน่ใจว่ามีช่องใส่ผู้แต่งอย่างน้อยหนึ่งช่องพร้อมปุ่มที่ถูกต้อง
    document.addEventListener('DOMContentLoaded', () => {
        if (authorsContainer.children.length === 0) {
            const initialAuthorInput = createAuthorInput();
            authorsContainer.appendChild(initialAuthorInput);
            // ถ้ามีแค่คนเดียว ให้เปลี่ยนปุ่มลบเป็นเพิ่ม
            const removeBtn = initialAuthorInput.querySelector('.remove-author');
            if (removeBtn) removeBtn.replaceWith(createAddButton());
        }
        updateSubmitButtonState(); // ตรวจสอบสถานะปุ่มเมื่อโหลดหน้า
    });


    authorsContainer.addEventListener('click', e => {
        if(e.target.classList.contains('add-author')) {
            const currentAuthorEntries = authorsContainer.querySelectorAll('.author-entry').length;
            const newAuthorEntry = createAuthorInput();
            authorsContainer.appendChild(newAuthorEntry);

            // ถ้าเพิ่งเพิ่มผู้แต่งคนที่สอง ให้เปลี่ยนปุ่มของคนแรกเป็นปุ่มลบ
            if (currentAuthorEntries === 1) { // เดิมมี 1 ช่อง แล้วจะเพิ่มเป็น 2 ช่อง
                const firstAuthorEntry = authorsContainer.children[0];
                const addButton = firstAuthorEntry.querySelector('.add-author');
                if (addButton) {
                    addButton.replaceWith(createRemoveButton());
                }
            }
            updateSubmitButtonState(); // อัปเดตสถานะปุ่มเมื่อเพิ่ม/ลบผู้แต่ง
        }
        if(e.target.classList.contains('remove-author')) {
            e.target.closest('.author-entry').remove();
            // ถ้าเหลือผู้แต่งคนเดียว ให้เปลี่ยนปุ่มลบเป็นปุ่มเพิ่ม
            if (authorsContainer.children.length === 1) {
                const soleAuthorEntry = authorsContainer.querySelector('.author-entry');
                const removeButton = soleAuthorEntry.querySelector('.remove-author');
                if (removeButton) {
                    removeButton.replaceWith(createAddButton());
                }
            } else if (authorsContainer.children.length === 0) {
                // หากลบจนหมด ให้สร้างช่องแรกพร้อมปุ่มเพิ่ม
                const initialAuthorInput = createAuthorInput();
                authorsContainer.appendChild(initialAuthorInput);
                const removeBtn = initialAuthorInput.querySelector('.remove-author');
                if (removeBtn) removeBtn.replaceWith(createAddButton());
            }
            updateSubmitButtonState(); // อัปเดตสถานะปุ่มเมื่อเพิ่ม/ลบผู้แต่ง
        }
    });


    // ฟังก์ชันแสดงข้อความสำหรับ Form
    const formMessage = document.getElementById('form-message');
    function showFormMessage(msg, type) {
        formMessage.textContent = msg;
        formMessage.className = `message ${type}`; // ใช้ className โดยตรง
        formMessage.classList.remove('hidden');
    }
    function hideFormMessage() {
        formMessage.classList.add('hidden');
        formMessage.textContent = '';
    }

    // ฟังก์ชันแสดงข้อความสำหรับ Image Upload
    const imageUploadMessage = document.getElementById('image-upload-message');
    function showImageUploadMessage(msg, type) {
        imageUploadMessage.textContent = msg;
        imageUploadMessage.className = `message ${type}`;
        imageUploadMessage.classList.remove('hidden');
    }
    function hideImageUploadMessage() {
        imageUploadMessage.classList.add('hidden');
        imageUploadMessage.textContent = '';
    }

    // ฟังก์ชันแสดงข้อความสำหรับ File Upload
    const fileUploadMessage = document.getElementById('file-upload-message');
    function showFileUploadMessage(msg, type) {
        fileUploadMessage.textContent = msg;
        fileUploadMessage.className = `message ${type}`;
        fileUploadMessage.classList.remove('hidden');
    }
    function hideFileUploadMessage() {
        fileUploadMessage.classList.add('hidden');
        fileUploadMessage.textContent = '';
    }

    // --- การจัดการอัปโหลดรูปภาพปก (Cover Image) ไปยัง Cloudinary ---
    const coverImageUploadBox = document.querySelector('#cover-image-upload').parentElement;
    const coverImageInput = document.getElementById('cover-image-upload');
    const coverImagePreviewContainer = document.getElementById('cover-image-preview-container'); // เพิ่ม container สำหรับรูปภาพและปุ่มลบ
    const uploadedImageDisplay = document.getElementById('uploaded-image-display');
    const imageUrlDisplay = document.getElementById('image-url-display');
    const uploadedImageUrlInput = document.getElementById('uploaded-image-url'); // Hidden input to store URL
    const removeCoverImageButton = document.getElementById('remove-cover-image'); // ปุ่มลบรูปภาพปก

    coverImageUploadBox.addEventListener('click', () => coverImageInput.click());

    coverImageInput.addEventListener('change', async () => {
        const file = coverImageInput.files[0];
        if (!file) {
            // ถ้าไม่มีไฟล์ถูกเลือกหรือถูกยกเลิกการเลือก
            uploadedImageUrlInput.value = '';
            coverImagePreviewContainer.classList.add('hidden'); // ซ่อน preview
            uploadedImageDisplay.src = ''; // เคลียร์ src
            imageUrlDisplay.textContent = ''; // เคลียร์ text
            hideImageUploadMessage();
            updateSubmitButtonState();
            return;
        }

        // ตรวจสอบชนิดไฟล์ (เฉพาะรูปภาพ)
        const allowedImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedImageTypes.includes(file.type)) {
            showImageUploadMessage('กรุณาเลือกไฟล์รูปภาพ (JPG, PNG, GIF, WEBP) เท่านั้น', 'error');
            coverImageInput.value = '';
            uploadedImageUrlInput.value = '';
            coverImagePreviewContainer.classList.add('hidden');
            uploadedImageDisplay.src = '';
            imageUrlDisplay.textContent = '';
            updateSubmitButtonState();
            return;
        }

        // ตรวจสอบขนาดไฟล์
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            showImageUploadMessage('ขนาดรูปภาพต้องไม่เกิน 5MB', 'error');
            coverImageInput.value = ''; // Clear selected file
            coverImagePreviewContainer.classList.add('hidden');
            uploadedImageUrlInput.value = '';
            uploadedImageDisplay.src = '';
            imageUrlDisplay.textContent = '';
            updateSubmitButtonState();
            return;
        }

        showImageUploadMessage('กำลังอัปโหลดรูปภาพปก...', 'info');
        document.getElementById('submit-btn').disabled = true; // Disable submit during upload
        coverImageInput.disabled = true; // ปิดปุ่มอัปโหลดชั่วคราว
        uploadedImageUrlInput.value = ''; // เคลียร์ URL เก่า
        coverImagePreviewContainer.classList.add('hidden'); // ซ่อน preview เก่า

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); // ใช้ preset เดียวกัน

        try {
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
                method: 'POST',
                body: formData,
            });
            const data = await response.json();

            if (data.secure_url) {
                uploadedImageDisplay.src = data.secure_url;
                imageUrlDisplay.textContent = data.secure_url;
                uploadedImageUrlInput.value = data.secure_url; // เก็บ URL ใน hidden input
                coverImagePreviewContainer.classList.remove('hidden');
                showImageUploadMessage('อัปโหลดรูปภาพปกสำเร็จ!', 'success');
            } else {
                showImageUploadMessage(`อัปโหลดรูปภาพปกไม่สำเร็จ: ${data.error ? data.error.message : 'ไม่ทราบข้อผิดพลาด'}`, 'error');
                coverImagePreviewContainer.classList.add('hidden');
            }
        } catch (error) {
            console.error('Cloudinary image upload error:', error);
            showImageUploadMessage('เกิดข้อผิดพลาดในการอัปโหลดรูปภาพปก', 'error');
            coverImagePreviewContainer.classList.add('hidden');
        } finally {
            coverImageInput.disabled = false;
            updateSubmitButtonState();
        }
    });

    // เพิ่ม Event Listener สำหรับปุ่มลบรูปภาพปก
    removeCoverImageButton.addEventListener('click', () => {
        uploadedImageUrlInput.value = ''; // Clear hidden input
        coverImageInput.value = ''; // Clear selected file
        uploadedImageDisplay.src = ''; // Clear image preview
        imageUrlDisplay.textContent = ''; // Clear URL text
        coverImagePreviewContainer.classList.add('hidden'); // Hide the container
        hideImageUploadMessage();
        updateSubmitButtonState();
    });


    // --- การจัดการอัปโหลดไฟล์ผลงานวิจัย (PDF/DOCX) ไปยัง Cloudinary ---
    const researchFileUploadBox = document.querySelector('#research-file-upload').parentElement;
    const researchFileInput = document.getElementById('research-file-upload');
    const researchFileListDiv = document.getElementById('research-file-list');
    const uploadedResearchFilesUrlInput = document.getElementById('uploaded-research-files-url'); // Hidden input for file URLs
    let pendingFileUploads = 0; // นับจำนวนไฟล์ที่กำลังอัปโหลด

    researchFileUploadBox.addEventListener('click', () => researchFileInput.click());

    researchFileInput.addEventListener('change', async () => {
        researchFileListDiv.innerHTML = ''; // Clear previous file list display
        uploadedResearchFilesUrlInput.value = ''; // Clear old URLs
        const uploadedFileUrls = [];

        if (researchFileInput.files.length === 0) {
            showFileUploadMessage('กรุณาเลือกไฟล์สำหรับอัปโหลด', 'info');
            updateSubmitButtonState();
            return;
        }

        // ตรวจสอบชนิดไฟล์ (เฉพาะ PDF และ DOCX)
        const allowedFileTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        for (const file of researchFileInput.files) {
            if (!allowedFileTypes.includes(file.type)) {
                showFileUploadMessage(`ไฟล์ "${file.name}" ไม่ใช่ PDF หรือ DOCX กรุณาเลือกไฟล์ใหม่`, 'error');
                researchFileInput.value = ''; // Clear all selected files
                researchFileListDiv.innerHTML = '';
                updateSubmitButtonState();
                return;
            }
            // ตรวจสอบขนาดไฟล์
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showFileUploadMessage(`ไฟล์ "${file.name}" มีขนาดเกิน 10MB กรุณาเลือกไฟล์ใหม่`, 'error');
                researchFileInput.value = ''; // Clear all selected files
                researchFileListDiv.innerHTML = '';
                updateSubmitButtonState();
                return;
            }
        }


        pendingFileUploads = researchFileInput.files.length;
        showFileUploadMessage(`กำลังอัปโหลดไฟล์ผลงานวิจัย ${pendingFileUploads} ไฟล์...`, 'info');
        document.getElementById('submit-btn').disabled = true; // Disable submit during upload
        researchFileInput.disabled = true; // Disable input during upload

        for (const file of researchFileInput.files) {
            const fileDiv = document.createElement('div');
            fileDiv.id = `file-status-${file.name.replace(/[^a-zA-Z0-9.]/g, '-')}`; // สร้าง ID ที่ไม่ซ้ำกันจากชื่อไฟล์
            fileDiv.textContent = `⏳ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB) - กำลังอัปโหลด...`;
            fileDiv.className = 'text-gray-700';
            researchFileListDiv.appendChild(fileDiv);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); // ใช้ preset เดียวกัน

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (data.secure_url) {
                    uploadedFileUrls.push(data.secure_url);
                    fileDiv.textContent = `✅ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB) - อัปโหลดสำเร็จ`;
                    fileDiv.classList.remove('text-gray-700'); // Remove info class
                    fileDiv.classList.add('text-green-700');
                } else {
                    fileDiv.textContent = `❌ ${file.name} - อัปโหลดไม่สำเร็จ: ${data.error ? data.error.message : 'ไม่ทราบข้อผิดพลาด'}`;
                    fileDiv.classList.remove('text-gray-700');
                    fileDiv.classList.add('text-red-700');
                    showFileUploadMessage('มีบางไฟล์อัปโหลดไม่สำเร็จ', 'error');
                }
            } catch (error) {
                console.error('Cloudinary file upload error:', error);
                fileDiv.textContent = `❌ ${file.name} - เกิดข้อผิดพลาดในการอัปโหลดไฟล์`;
                fileDiv.classList.remove('text-gray-700');
                fileDiv.classList.add('text-red-700');
                showFileUploadMessage('เกิดข้อผิดพลาดในการอัปโหลดไฟล์', 'error');
            } finally {
                pendingFileUploads--;
                if (pendingFileUploads === 0) {
                    uploadedResearchFilesUrlInput.value = JSON.stringify(uploadedFileUrls);
                    if (uploadedFileUrls.length === researchFileInput.files.length) {
                        showFileUploadMessage(`อัปโหลดไฟล์ผลงานวิจัย ${uploadedFileUrls.length} ไฟล์สำเร็จ!`, 'success');
                    } else if (uploadedFileUrls.length > 0) {
                        showFileUploadMessage(`อัปโหลดไฟล์บางส่วนสำเร็จ (${uploadedFileUrls.length}/${researchFileInput.files.length} ไฟล์)`, 'info');
                    } else {
                        showFileUploadMessage('ไม่มีไฟล์ใดอัปโหลดสำเร็จ', 'error');
                    }
                    researchFileInput.disabled = false;
                    updateSubmitButtonState();
                }
            }
        }
    });

    // ฟังก์ชันสำหรับควบคุมสถานะของปุ่ม Submit
    // จะถูกเรียกเมื่อมีการอัปโหลดไฟล์หรือเมื่อฟอร์มถูกรีเซ็ต
    function updateSubmitButtonState() {
        const isImageUploaded = uploadedImageUrlInput.value !== '';
        const areFilesUploaded = JSON.parse(uploadedResearchFilesUrlInput.value || '[]').length > 0;

        // ปุ่มจะถูกเปิดใช้งานถ้า:
        // 1. มีการอัปโหลดรูปภาพปกแล้ว AND
        // 2. มีการอัปโหลดไฟล์ผลงานวิจัยแล้ว AND
        // 3. ไม่มีไฟล์ใดกำลังรออัปโหลด (pendingFileUploads === 0)
        // 4. ไม่มี error message แสดงอยู่
        const hasFormError = !formMessage.classList.contains('hidden') && formMessage.classList.contains('error');
        const hasImageUploadError = !imageUploadMessage.classList.contains('hidden') && imageUploadMessage.classList.contains('error');
        const hasFileUploadError = !fileUploadMessage.classList.contains('hidden') && fileUploadMessage.classList.contains('error');

        document.getElementById('submit-btn').disabled = !(isImageUploaded && areFilesUploaded && pendingFileUploads === 0 && !hasFormError && !hasImageUploadError && !hasFileUploadError);
    }

    // เพิ่ม Event Listeners ให้กับช่อง Input ที่เป็น required เพื่อเรียก updateSubmitButtonState
    document.querySelectorAll('#research-form input[required], #research-form select[required], #research-form textarea[required]').forEach(input => {
        input.addEventListener('input', updateSubmitButtonState);
        input.addEventListener('change', updateSubmitButtonState); // สำหรับ select
    });
    // เพิ่ม Event Listener สำหรับ input ผู้จัดทำ (อาจจะต้องจับเหตุการณ์ที่ซับซ้อนกว่า input ทั่วไป)
    authorsContainer.addEventListener('input', updateSubmitButtonState);


    // ปุ่มยกเลิก
    document.getElementById('cancel-btn').addEventListener('click', () => {
        if(confirm('ต้องการยกเลิกและล้างข้อมูลทั้งหมดหรือไม่?')) {
            document.getElementById('research-form').reset();
            categoryItems.forEach(i => i.classList.remove('selected'));
            selectedCategoryInput.value = '';

            // ลบผู้จัดทำที่เพิ่มเข้ามา ให้เหลือแค่คนแรกพร้อมปุ่มเพิ่ม
            authorsContainer.innerHTML = ''; // เคลียร์ทั้งหมด
            const initialAuthorInput = createAuthorInput();
            authorsContainer.appendChild(initialAuthorInput);
            const removeBtn = initialAuthorInput.querySelector('.remove-author');
            if (removeBtn) removeBtn.replaceWith(createAddButton());


            // เคลียร์สถานะการอัปโหลดไฟล์และรูปภาพ
            uploadedImageUrlInput.value = '';
            coverImagePreviewContainer.classList.add('hidden');
            uploadedImageDisplay.src = ''; // เคลียร์รูปภาพใน preview
            imageUrlDisplay.textContent = '';
            coverImageInput.value = ''; // เคลียร์ไฟล์ที่เลือกใน input (รูปภาพ)

            uploadedResearchFilesUrlInput.value = '';
            researchFileListDiv.innerHTML = '';
            researchFileInput.value = ''; // เคลียร์ไฟล์ที่เลือกใน input (เอกสาร)


            hideFormMessage();
            hideImageUploadMessage();
            hideFileUploadMessage();
            pendingFileUploads = 0; // รีเซ็ตตัวนับการอัปโหลดที่รอดำเนินการ
            updateSubmitButtonState(); // Ensure submit button state is correct after cancel
        }
    });

    // ส่งข้อมูลทั้งหมดไปยัง Google Apps Script Web App
    document.getElementById('research-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        // ตรวจสอบความถูกต้องของข้อมูล (Required fields) อีกครั้งก่อนส่ง
        // เพื่อป้องกันการส่งข้อมูลที่ไม่สมบูรณ์ในกรณีที่ updateSubmitButtonState ไม่ได้ครอบคลุม
        if (!document.getElementById('title').value.trim() ||
            !selectedCategoryInput.value.trim() ||
            !document.getElementById('department').value.trim() ||
            !document.getElementById('field').value.trim() ||
            !document.getElementById('year').value.trim() ||
            !document.getElementById('academic-year').value.trim() ||
            !document.getElementById('advisor').value.trim() ||
            !document.getElementById('abstract').value.trim()) {
            showFormMessage('กรุณากรอกข้อมูลให้ครบถ้วนทุกช่องที่มีเครื่องหมาย *', 'error');
            updateSubmitButtonState();
            return;
        }

        const authorsInputs = document.querySelectorAll('input[name="authors[]"]');
        let allAuthorsFilled = true;
        authorsInputs.forEach(input => {
            if (input.value.trim() === '') {
                allAuthorsFilled = false;
            }
        });
        if (!allAuthorsFilled) {
            showFormMessage('กรุณากรอกชื่อผู้จัดทำให้ครบถ้วน', 'error');
            updateSubmitButtonState();
            return;
        }

        // ตรวจสอบว่าอัปโหลดรูปภาพปกแล้ว
        if (!uploadedImageUrlInput.value) {
            showFormMessage('กรุณาอัปโหลดรูปภาพปกผลงานวิจัย', 'error');
            updateSubmitButtonState();
            return;
        }
        // ตรวจสอบว่าอัปโหลดไฟล์ผลงานวิจัยแล้ว
        let researchFileUrls = [];
        try {
            researchFileUrls = JSON.parse(uploadedResearchFilesUrlInput.value || '[]');
        } catch (e) {
            showFormMessage('ข้อมูล URL ไฟล์ผลงานวิจัยไม่ถูกต้อง', 'error');
            updateSubmitButtonState();
            return;
        }
        if (researchFileUrls.length === 0) {
            showFormMessage('กรุณาอัปโหลดไฟล์ผลงานวิจัย', 'error');
            updateSubmitButtonState();
            return;
        }
        if (pendingFileUploads > 0) {
            showFormMessage('กำลังอัปโหลดไฟล์บางส่วน กรุณารอสักครู่', 'info');
            updateSubmitButtonState();
            return;
        }


        showFormMessage('กำลังส่งข้อมูล... กรุณารอสักครู่', 'info');
        document.getElementById('submit-btn').disabled = true;

        // ดึง username จาก localStorage
        let loggedInUser = null;
        try {
            loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        } catch (e) {
            console.error("Error parsing loggedInUser from localStorage", e);
        }
        const submittedByUsername = loggedInUser && loggedInUser.username ? loggedInUser.username : 'Anonymous';


        // รวบรวมข้อมูลทั้งหมดในรูปแบบ FormData
        const formData = new FormData();
        formData.append('action', 'submitResearch');
        formData.append('id', `res-${Date.now()}-${Math.floor(Math.random() * 1000000)}`); // ID ที่ไม่ซ้ำกัน
        formData.append('title', document.getElementById('title').value.trim());
        formData.append('category', selectedCategoryInput.value.trim());
        formData.append('department', document.getElementById('department').value.trim());
        formData.append('field', document.getElementById('field').value.trim());
        formData.append('year', document.getElementById('year').value.trim());
        formData.append('academicYear', document.getElementById('academic-year').value.trim());
        formData.append('authors', Array.from(document.querySelectorAll('input[name="authors[]"]')).map(input => input.value.trim()).filter(Boolean).join(', '));
        formData.append('advisor', document.getElementById('advisor').value.trim());
        formData.append('abstract', document.getElementById('abstract').value.trim());
        formData.append('coverImageUrl', uploadedImageUrlInput.value);
        formData.append('researchFileUrls', JSON.stringify(researchFileUrls));
        formData.append('timestamp', new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }));
        formData.append('submittedBy', submittedByUsername); // เพิ่ม submittedBy

        try {
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();

            if (result.success) { // เปลี่ยนจาก result.status เป็น result.success เพื่อให้ตรงกับ Apps Script
                showFormMessage('ส่งข้อมูลผลงานวิจัยสำเร็จแล้ว! ข้อมูลจะถูกตรวจสอบและอนุมัติโดยผู้ดูแลระบบ', 'success');
                // ล้างฟอร์มทั้งหมด
                document.getElementById('research-form').reset();
                categoryItems.forEach(i => i.classList.remove('selected'));
                selectedCategoryInput.value = '';

                // Reset ผู้จัดทำ
                authorsContainer.innerHTML = '';
                const initialAuthorInput = createAuthorInput();
                authorsContainer.appendChild(initialAuthorInput);
                const removeBtn = initialAuthorInput.querySelector('.remove-author');
                if (removeBtn) removeBtn.replaceWith(createAddButton());


                uploadedImageUrlInput.value = '';
                coverImagePreviewContainer.classList.add('hidden'); // ซ่อน container
                uploadedImageDisplay.src = '';
                imageUrlDisplay.textContent = '';
                coverImageInput.value = ''; // เคลียร์ไฟล์ที่เลือกใน input (รูปภาพ)

                uploadedResearchFilesUrlInput.value = '';
                researchFileListDiv.innerHTML = '';
                researchFileInput.value = ''; // เคลียร์ไฟล์ที่เลือกใน input (เอกสาร)


                hideImageUploadMessage();
                hideFileUploadMessage();
            } else {
                showFormMessage(`เกิดข้อผิดพลาด: ${result.message || 'ไม่สามารถส่งข้อมูลได้'}`, 'error');
            }
        } catch (error) {
            console.error('Error submitting research to Google Apps Script:', error);
            showFormMessage('เกิดข้อผิดพลาดในการเชื่อมต่อกับ Apps Script', 'error');
        } finally {
            document.getElementById('submit-btn').disabled = false;
            updateSubmitButtonState(); // เรียกอัปเดตสถานะปุ่มเมื่อเสร็จสิ้นการส่ง
            setTimeout(() => {
                hideFormMessage();
            }, 7000);
        }
    });
</script>
</body>
</html>
