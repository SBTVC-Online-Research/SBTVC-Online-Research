<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>อัปโหลดรูปโปรไฟล์</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #f0f4f8;
    }
    .upload-box {
      border: 2px dashed #9CA3AF; /* gray-400 */
      transition: all 0.3s ease;
    }
    .upload-box:hover {
      border-color: #4F46E5; /* indigo-600 */
      background-color: #EEF2FF; /* indigo-50 */
    }
    /* Styles for message boxes */
    .message {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        text-align: center;
    }
    .message.success {
        background-color: #d1fae5; /* green-100 */
        color: #065f46; /* green-800 */
    }
    .message.error {
        background-color: #fee2e2; /* red-100 */
        color: #991b1b; /* red-800 */
    }
    .message.info {
        background-color: #e0f2fe; /* blue-100 */
        color: #1e40af; /* blue-800 */
    }
  </style>
</head>
<body>

<header class="bg-gradient-to-r from-indigo-600 to-blue-700 text-white py-6 shadow-lg">
  <div class="container mx-auto px-4">
    <h1 class="text-3xl font-bold">ระบบอัปโหลดรูปโปรไฟล์</h1>
    <p class="mt-2 text-indigo-100">กรอกข้อมูลและอัปโหลดรูปภาพของคุณ</p>
  </div>
</header>

<main class="container mx-auto px-4 py-8">
  <div class="bg-white rounded-lg shadow-lg p-6 md:p-8 max-w-2xl mx-auto">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6">กรอกข้อมูลผู้ใช้และอัปโหลดรูป</h2>
    <form id="upload-form">
      <div class="mb-6">
        <label for="username" class="block text-gray-700 font-medium mb-2">ชื่อผู้ใช้ <span class="text-red-500">*</span></label>
        <input type="text" id="username" name="username" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none" required>
      </div>

      <div class="mb-8">
        <label class="block text-gray-700 font-medium mb-2">อัปโหลดรูปโปรไฟล์ (ไม่เกิน 5MB) <span class="text-red-500">*</span></label>
        <div class="upload-box bg-gray-50 rounded-lg p-8 text-center cursor-pointer">
          <input type="file" id="profile-image-upload" class="hidden" accept="image/*">
          <div>
            <svg class="h-12 w-12 mx-auto text-blue-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/></svg>
          </div>
          <p class="font-medium text-gray-700">ลากรูปภาพหรือคลิกเพื่อเลือก</p>
          <p class="text-sm text-gray-500">รองรับ: JPG, PNG, GIF (สูงสุด 5MB/ไฟล์)</p>
        </div>
        <div id="image-preview" class="mt-4 text-center hidden">
            <img id="uploaded-image-display" src="" alt="รูปโปรไฟล์" class="max-w-xs mx-auto rounded-lg shadow-md mb-2">
            <p id="image-url-display" class="text-sm text-blue-600 truncate"></p>
        </div>
        <input type="hidden" id="uploaded-image-url" name="imageUrl">
        <div id="image-upload-message" class="message hidden"></div>
      </div>

      <div id="form-message" class="message hidden"></div>
      <div class="flex justify-end space-x-4">
        <button type="button" id="cancel-btn" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">ยกเลิก</button>
        <button type="submit" id="submit-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ส่งข้อมูล</button>
      </div>
    </form>
  </div>
</main>

<script>
  // **Cloudinary Configuration** //
  const CLOUDINARY_CLOUD_NAME = 'davuwvefc'; // <-- Cloud name ของคุณ
  const CLOUDINARY_IMAGE_UPLOAD_PRESET = 'STVC_preset'; // <-- ชื่อ Unsigned preset สำหรับรูปภาพ

  // DOM Elements
  const uploadForm = document.getElementById('upload-form');
  const usernameInput = document.getElementById('username');
  const profileImageUploadBox = document.querySelector('#profile-image-upload').parentElement;
  const profileImageInput = document.getElementById('profile-image-upload');
  const imagePreviewDiv = document.getElementById('image-preview');
  const uploadedImageDisplay = document.getElementById('uploaded-image-display');
  const imageUrlDisplay = document.getElementById('image-url-display');
  const uploadedImageUrlInput = document.getElementById('uploaded-image-url'); // Hidden input to store URL
  const formMessage = document.getElementById('form-message');
  const imageUploadMessage = document.getElementById('image-upload-message');
  const submitBtn = document.getElementById('submit-btn');
  const cancelBtn = document.getElementById('cancel-btn');

  // --- Message Display Functions ---
  function showMessage(element, msg, type) {
      element.textContent = msg;
      element.className = `message ${type}`;
      element.classList.remove('hidden');
  }

  function hideMessage(element) {
      element.classList.add('hidden');
      element.textContent = '';
  }

  // --- Handle Profile Image Upload to Cloudinary ---
  profileImageUploadBox.addEventListener('click', () => profileImageInput.click());

  profileImageInput.addEventListener('change', async () => {
    const file = profileImageInput.files[0];
    if (!file) {
        uploadedImageUrlInput.value = ''; // Clear if no file selected
        imagePreviewDiv.classList.add('hidden');
        hideMessage(imageUploadMessage); // Clear message
        return;
    }

    if (file.size > 5 * 1024 * 1024) { // 5MB limit
      showMessage(imageUploadMessage, 'ขนาดรูปภาพต้องไม่เกิน 5MB', 'error');
      profileImageInput.value = ''; // Clear selected file
      imagePreviewDiv.classList.add('hidden');
      uploadedImageUrlInput.value = '';
      return;
    }

    showMessage(imageUploadMessage, 'กำลังอัปโหลดรูปภาพ...', 'info');
    profileImageInput.disabled = true; // Disable input during upload
    submitBtn.disabled = true; // Disable submit button during upload
    uploadedImageUrlInput.value = ''; // Clear old URL
    imagePreviewDiv.classList.add('hidden'); // Hide old preview during upload

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_IMAGE_UPLOAD_PRESET);

    try {
      const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
        method: 'POST',
        body: formData,
      });
      const data = await response.json();

      if (data.secure_url) {
        uploadedImageDisplay.src = data.secure_url;
        imageUrlDisplay.textContent = data.secure_url;
        uploadedImageUrlInput.value = data.secure_url; // Store URL in hidden input
        imagePreviewDiv.classList.remove('hidden');
        showMessage(imageUploadMessage, 'อัปโหลดรูปภาพสำเร็จ!', 'success');
      } else {
        showMessage(imageUploadMessage, `อัปโหลดรูปภาพล้มเหลว: ${data.error.message || 'ไม่ทราบข้อผิดพลาด'}`, 'error');
        imagePreviewDiv.classList.add('hidden');
      }
    } catch (error) {
      console.error('Cloudinary image upload error:', error);
      showMessage(imageUploadMessage, 'เกิดข้อผิดพลาดในการอัปโหลดรูปภาพ', 'error');
      imagePreviewDiv.classList.add('hidden');
    } finally {
      profileImageInput.disabled = false;
      submitBtn.disabled = false;
    }
  });

  // --- Cancel Button ---
  cancelBtn.addEventListener('click', () => {
    if(confirm('ต้องการยกเลิกและล้างข้อมูลทั้งหมดหรือไม่?')) {
      uploadForm.reset();
      
      // Clear image upload state
      uploadedImageUrlInput.value = '';
      imagePreviewDiv.classList.add('hidden');
      hideMessage(imageUploadMessage);
      hideMessage(formMessage);
      usernameInput.focus(); // Focus back to username field
    }
  });

  // --- Form Submission Logic: Save to localStorage ---
  uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Basic form validation for required fields
    if (!usernameInput.value.trim()) {
      showMessage(formMessage, 'กรุณากรอกชื่อผู้ใช้', 'error');
      return;
    }
    
    if (!uploadedImageUrlInput.value) {
      showMessage(formMessage, 'กรุณาอัปโหลดรูปโปรไฟล์', 'error');
      return;
    }

    // Prepare data to save
    const newImageEntry = {
        username: usernameInput.value.trim(),
        imageUrl: uploadedImageUrlInput.value,
        timestamp: new Date().toISOString(),
        status: 'pending' // Default status for new uploads
    };

    // Get existing data from localStorage or initialize an empty array
    let existingImages = JSON.parse(localStorage.getItem('uploadedImages')) || [];
    existingImages.push(newImageEntry);

    // Save updated data back to localStorage
    localStorage.setItem('uploadedImages', JSON.stringify(existingImages));

    showMessage(formMessage, 'ข้อมูลและรูปภาพของคุณถูกบันทึกเรียบร้อยแล้ว!', 'success');
    submitBtn.disabled = true; // Disable the button after successful submission

    // Optional: Reset form after a short delay
    setTimeout(() => {
        uploadForm.reset();
        uploadedImageUrlInput.value = '';
        imagePreviewDiv.classList.add('hidden');
        hideMessage(imageUploadMessage);
        hideMessage(formMessage);
        submitBtn.disabled = false; // Re-enable the button to allow new submissions
    }, 5000); // Reset after 5 seconds
  });
</script>

</body>
</html>
