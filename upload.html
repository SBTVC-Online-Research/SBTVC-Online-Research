<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>อัปโหลดผลงานวิจัย</title>
    <style>
        /* Base Styles for Body and Container to mimic original design */
        body {
            font-family: Arial, sans-serif;
            background-color: #f07026; /* Light grey background, similar to original screenshots */
            margin: 0;
            padding: 20px; /* Add some padding around the form */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
        }

        .container {
            max-width: 960px; /* A common width for forms, adjust as needed */
            width: 100%;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px; /* Slightly rounded corners */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            margin-top: 20px; /* Add some top margin to differentiate from header */
            box-sizing: border-box; /* Ensure padding doesn't increase total width */
        }

        h1 {
            font-size: 1.8em; /* Larger title */
            font-weight: bold;
            color: #333; /* Darker text */
            margin-bottom: 25px; /* More space below title */
            text-align: center;
        }

        /* Form Group Styles (Labels and Inputs) */
        .form-group {
            margin-bottom: 20px; /* Spacing between form groups */
        }
        .form-group label {
            display: block;
            font-size: 0.9em; /* Slightly smaller label text */
            font-weight: 600; /* Bolder label */
            color: #555; /* Medium gray text */
            margin-bottom: 8px; /* Space between label and input */
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            padding: 10px 12px; /* Comfortable padding */
            border: 1px solid #ccc; /* Light border */
            border-radius: 5px; /* Rounded input corners */
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.07); /* Inner shadow for depth */
            font-size: 1em;
            color: #333;
            box-sizing: border-box; /* Essential for consistent width */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #d67419; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(153, 107, 9, 0.25); /* Blue focus ring */
        }
        .text-red-500 {
            color: #dc3545; /* Bootstrap-like red for required fields */
        }

        /* Message Box styles - คงไว้ตามที่คุณให้มา (แต่เปลี่ยนจาก Tailwind colors เป็น CSS ตรงๆ) */
        .message-box {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        .message-box.info {
            background-color: #e0f2fe; /* blue-100 */
            color: #e03f0d; /* blue-500 */
        }
        .message-box.success {
            background-color: #e8f5e9; /* green-100 */
            color: #4caf50; /* green-500 */
        }
        .message-box.error {
            background-color: #ffebee; /* red-100 */
            color: #f44336; /* red-500 */
        }
        .message-box.warning {
            background-color: #fffde7; /* yellow-100 */
            color: #ffc107; /* yellow-500 */
        }
        .message-box.hidden {
            display: none;
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Adjusted for better layout */
            gap: 10px; /* Smaller gap */
            margin-top: 5px;
        }
        .category-item {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f8f8f8; /* Slightly off-white */
            color: #444;
        }
        .category-item:hover {
            background-color: #e9ecef; /* Lighter hover */
            border-color: #a8a8a8;
        }
        .category-item.selected {
            background-color: #28a745; /* Primary blue for selected */
            color: #ffffff;
            border-color: #007bff;
        }

        /* Author Entry */
        .author-entry {
            display: flex;
            align-items: center;
            margin-bottom: 10px; /* Space between author fields */
        }
        .author-entry:last-child {
            margin-bottom: 0;
        }
        .author-entry input {
            flex-grow: 1;
            margin-right: 10px; /* Space between input and buttons */
        }
        .author-actions {
            display: flex;
            gap: 5px; /* Gap between buttons */
        }
        .author-actions button {
            padding: 8px 15px; /* Adjusted padding for buttons */
            border-radius: 5px;
            font-size: 0.85em; /* Smaller button text */
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }
        .author-actions .add-author {
            background-color: #28a745; /* Green for add */
            color: #ffffff;
        }
        .author-actions .add-author:hover {
            background-color: #218838;
        }
        .author-actions .remove-author {
            background-color: #dc3545; /* Red for remove */
            color: #ffffff;
        }
        .author-actions .remove-author:hover {
            background-color: #c82333;
        }

        /* File Upload Styles */
        input[type="file"] {
            display: block;
            width: 100%;
            margin-top: 8px;
            font-size: 0.9em;
            color: #555;
            padding: 5px 0; /* Adjust padding for file input */
        }
        input[type="file"]::-webkit-file-upload-button {
            background-color: #e9ecef; /* Light gray button */
            color: #333;
            border: 1px solid #ccc;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        input[type="file"]::file-selector-button { /* Standard property */
            background-color: #e9ecef;
            color: #333;
            border: 1px solid #ccc;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        input[type="file"]::-webkit-file-upload-button:hover,
        input[type="file"]::file-selector-button:hover {
            background-color: #dee2e6;
        }

        /* Image Preview */
        #cover-image-preview {
            margin-top: 15px;
            display: none; /* hidden by default */
            background-color: #f9f9f9;
            border: 1px dashed #e0e0e0;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        #cover-image-preview.visible {
            display: block;
        }
        #uploaded-image-display {
            max-width: 180px; /* Smaller preview image */
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }
        #cover-image-preview p {
            font-size: 0.8em;
            color: #666;
            word-break: break-all; /* Allow long URLs to break */
        }
        #image-url-display {
            color: #007bff; /* Blue for URL */
            font-weight: bold;
        }

        /* Research File List */
        #research-file-list {
            margin-top: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            background-color: #fdfdfd;
        }
        #research-file-list > div {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        #research-file-list > div:last-child {
            border-bottom: none;
        }
        #research-file-list span {
            font-size: 0.85em;
            color: #555;
        }
        #research-file-list .text-gray-500 { color: #888; }
        #research-file-list .text-green-600 { color: #28a745; }
        #research-file-list .text-red-600 { color: #dc3545; }

        /* Buttons */
        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 15px; /* Spacing between buttons */
            margin-top: 30px;
            padding-top: 20px; /* Add padding above buttons */
            border-top: 1px solid #eee; /* Separator line */
        }
        .button-group button {
            padding: 10px 25px;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #cancel-btn {
            background-color: #f8f9fa; /* Light background */
            color: #333;
            border: 1px solid #ccc;
        }
        #cancel-btn:hover {
            background-color: #e2e6ea;
            border-color: #b8b8b8;
        }
        #cancel-btn:focus, #submit-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(156, 81, 11, 0.25); /* Consistent focus ring */
        }
        #submit-btn {
            background-color: #915b0b; /* Primary blue for submit */
            color: #ffffff;
            border: 1px solid #000000;
        }
        #submit-btn:hover {
            background-color: #000000;
            border-color: #000000;
        }
        #submit-btn:disabled {
            background-color: #a0cffc; /* Lighter blue for disabled */
            border-color: #a0cffc;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>อัปโหลดผลงานวิจัยใหม่</h1>
        
        <div id="form-message" class="message-box hidden" role="alert"></div>
        <div id="image-upload-message" class="message-box hidden" role="alert"></div>
        <div id="file-upload-message" class="message-box hidden" role="alert"></div>

        <form id="research-form">
            <div class="form-group">
                <label for="title">ชื่อผลงานวิจัย <span class="text-red-500">*</span></label>
                <input type="text" id="title" name="title" required>
            </div>

            <div class="form-group">
                <label>หมวดหมู่ <span class="text-red-500">*</span></label>
                <div class="category-grid">
                    <div class="category-item" data-value="บทความวิจัย">บทความวิจัย</div>
                    <div class="category-item" data-value="วิทยานิพนธ์">วิทยานิพนธ์</div>
                    <div class="category-item" data-value="สารนิพนธ์">สารนิพนธ์</div>
                    <div class="category-item" data-value="การศึกษาอิสระ">การศึกษาอิสระ</div>
                    <div class="category-item" data-value="งานวิจัยรับจ้าง">งานวิจัยรับจ้าง</div>
                    <div class="category-item" data-value="อื่นๆ">อื่นๆ</div>
                </div>
                <input type="hidden" id="selected-category" name="category" required>
            </div>

            <div class="form-group">
                <label for="department">สาขา <span class="text-red-500">*</span></label>
                <input type="text" id="department" name="department" required>
            </div>

            <div class="form-group">
                <label for="field">กลุ่มวิชา/แขนงวิชา <span class="text-red-500">*</span></label>
                <input type="text" id="field" name="field" required>
            </div>

            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <label for="year">ปีที่ทำ <span class="text-red-500">*</span></label>
                    <input type="number" id="year" name="year" required>
                </div>
                <div>
                    <label for="academic-year">ปีการศึกษา <span class="text-red-500">*</span></label>
                    <input type="text" id="academic-year" name="academicYear" placeholder="เช่น 2566/2567" required>
                </div>
            </div>

            <div class="form-group">
                <label for="authors-container">ผู้จัดทำ <span class="text-red-500">*</span></label>
                <div id="authors-container">
                    </div>
            </div>

            <div class="form-group">
                <label for="advisor">อาจารย์ที่ปรึกษา <span class="text-red-500">*</span></label>
                <input type="text" id="advisor" name="advisor" required>
            </div>

            <div class="form-group">
                <label for="abstract">บทคัดย่อ <span class="text-red-500">*</span></label>
                <textarea id="abstract" name="abstract" rows="5" required></textarea>
            </div>

            <div class="form-group">
                <label for="cover-image-input">รูปภาพปกผลงานวิจัย <span class="text-red-500">*</span></label>
                <input type="file" id="cover-image-input" accept="image/*">
                <input type="hidden" id="uploaded-image-url" name="coverImageUrl">
                <div id="cover-image-preview">
                    <img id="uploaded-image-display" src="" alt="Cover Image Preview">
                    <p>URL: <span id="image-url-display"></span></p>
                </div>
            </div>

            <div class="form-group">
                <label for="research-file-input">ไฟล์ผลงานวิจัย (.pdf, .doc, .docx, .ppt, .pptx) <span class="text-red-500">*</span></label>
                <input type="file" id="research-file-input" multiple accept=".pdf,.doc,.docx,.ppt,.pptx">
                <input type="hidden" id="uploaded-research-files-url" name="researchFileUrls">
                <div id="research-file-list">
                    </div>
            </div>

            <div class="button-group">
                <button type="button" id="cancel-btn">
                    ยกเลิก
                </button>
                <button type="submit" id="submit-btn" disabled>
                    ส่งข้อมูล
                </button>
            </div>
        </form>
    </div>

<script>
    // **สำคัญมาก: แทนที่ด้วย Web App URL ที่คุณ Deploy จาก Google Apps Script ของคุณ**
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-QTyfdSXqxmqVNoql7uRkoRZuGCHlZOJA-atzZT4ZEnIiLE_92v6dEm6iR3hBOzkp/exec'; 
    
    // Cloudinary Configuration (แทนที่ด้วย Cloud Name และ Preset ของคุณ)
    const CLOUDINARY_CLOUD_NAME = 'davuwvefc';
    const CLOUDINARY_UPLOAD_PRESET_IMAGE = 'STVC_preset'; // สำหรับรูปภาพปก
    const CLOUDINARY_UPLOAD_PRESET_FILES = 'STVC_preset'; // สำหรับไฟล์วิจัย (PDF, DOCX ฯลฯ)

    const formMessageDiv = document.getElementById('form-message');
    const imageUploadMessageDiv = document.getElementById('image-upload-message');
    const fileUploadMessageDiv = document.getElementById('file-upload-message');

    function showFormMessage(message, type = 'info') {
        formMessageDiv.textContent = message;
        formMessageDiv.className = `message-box ${type}`;
        formMessageDiv.classList.remove('hidden');
    }
    function hideFormMessage() {
        formMessageDiv.classList.add('hidden');
    }

    function showImageUploadMessage(message, type = 'info') {
        imageUploadMessageDiv.textContent = message;
        imageUploadMessageDiv.className = `message-box ${type}`;
        imageUploadMessageDiv.classList.remove('hidden');
    }
    function hideImageUploadMessage() {
        imageUploadMessageDiv.classList.add('hidden');
    }

    function showFileUploadMessage(message, type = 'info') {
        fileUploadMessageDiv.textContent = message;
        fileUploadMessageDiv.className = `message-box ${type}`;
        fileUploadMessageDiv.classList.remove('hidden');
    }
    function hideFileUploadMessage() {
        fileUploadMessageDiv.classList.add('hidden');
    }

    const categoryItems = document.querySelectorAll('.category-item');
    const selectedCategoryInput = document.getElementById('selected-category');
    const authorsContainer = document.getElementById('authors-container');
    const coverImageInput = document.getElementById('cover-image-input');
    const uploadedImageUrlInput = document.getElementById('uploaded-image-url');
    const coverImagePreview = document.getElementById('cover-image-preview');
    const uploadedImageDisplay = document.getElementById('uploaded-image-display');
    const imageUrlDisplay = document.getElementById('image-url-display');

    const researchFileInput = document.getElementById('research-file-input');
    const uploadedResearchFilesUrlInput = document.getElementById('uploaded-research-files-url');
    const researchFileListDiv = document.getElementById('research-file-list');

    let pendingFileUploads = 0; // ตัวนับไฟล์ที่กำลังอัปโหลด
    let uploadedImageInfo = null; // เก็บข้อมูลรูปภาพปกที่อัปโหลดแล้ว
    let uploadedFileInfos = []; // เก็บข้อมูลไฟล์วิจัยที่อัปโหลดแล้ว [{url: 'url', name: 'name', type: 'type'}]

    const submitButton = document.getElementById('submit-btn');

    // ฟังก์ชันตรวจสอบความถูกต้องของฟอร์ม
    function checkFormValidity() {
        const form = document.getElementById('research-form');
        const requiredInputs = form.querySelectorAll('[required]');
        let allRequiredFilled = true;

        requiredInputs.forEach(input => {
            if (input.type === 'hidden' && input.id === 'selected-category') {
                if (!input.value) { // Category must be selected
                    allRequiredFilled = false;
                }
            } else if (input.type === 'hidden' && input.id === 'uploaded-image-url') {
                if (!input.value) { // Cover image must be uploaded
                    allRequiredFilled = false;
                }
            } else if (input.type === 'hidden' && input.id === 'uploaded-research-files-url') {
                if (uploadedFileInfos.length === 0) { // At least one research file must be uploaded
                    allRequiredFilled = false;
                }
            } else if (input.tagName === 'TEXTAREA' || input.tagName === 'INPUT') {
                 if (input.value.trim() === '') {
                    allRequiredFilled = false;
                }
            }
        });

        // ตรวจสอบผู้จัดทำ
        const authorInputs = document.querySelectorAll('input[name="authors[]"]');
        let authorsFilled = false;
        if (authorInputs.length > 0) {
            authorsFilled = Array.from(authorInputs).every(input => input.value.trim() !== '');
        } else {
            authorsFilled = false; // ต้องมีอย่างน้อย 1 ผู้จัดทำ
        }
        
        // ถ้ามีไฟล์ที่กำลังอัปโหลดอยู่ ให้ปุ่มเป็น disabled
        if (pendingFileUploads > 0) {
            submitButton.disabled = true;
            return;
        }

        submitButton.disabled = !(allRequiredFilled && authorsFilled);
    }

    // Listener สำหรับฟิลด์ทั่วไป
    document.getElementById('research-form').addEventListener('input', checkFormValidity);

    // เลือกหมวดหมู่
    categoryItems.forEach(item => {
        item.addEventListener('click', () => {
            categoryItems.forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            selectedCategoryInput.value = item.dataset.value;
            checkFormValidity(); // ตรวจสอบสถานะฟอร์มเมื่อเลือกหมวดหมู่
        });
    });

    // เพิ่ม/ลบผู้จัดทำ
    function createAddButton() {
        const button = document.createElement('button');
        button.type = 'button';
        button.classList.add('add-author'); /* ใช้แค่ class name */
        button.textContent = 'เพิ่ม';
        button.addEventListener('click', addAuthorField);
        return button;
    }

    function createRemoveButton() {
        const button = document.createElement('button');
        button.type = 'button';
        button.classList.add('remove-author'); /* ใช้แค่ class name */
        button.textContent = 'ลบ';
        button.addEventListener('click', function() {
            this.closest('.author-entry').remove();
            checkAuthorButtons();
            checkFormValidity();
        });
        return button;
    }

    function addAuthorField() {
        const div = document.createElement('div');
        div.classList.add('author-entry'); /* ใช้แค่ class name */
        div.innerHTML = `
            <input type="text" name="authors[]" placeholder="ชื่อ-นามสกุล ผู้จัดทำ" required>
            <div class="author-actions"></div>
        `;
        const actionsDiv = div.querySelector('.author-actions');
        actionsDiv.appendChild(createAddButton());
        actionsDiv.appendChild(createRemoveButton());
        authorsContainer.appendChild(div);
        checkAuthorButtons();
        checkFormValidity();
    }

    function checkAuthorButtons() {
        const authorEntries = authorsContainer.querySelectorAll('.author-entry');
        if (authorEntries.length === 1) {
            // ถ้ามีเพียงช่องเดียว ให้แสดงเฉพาะปุ่มเพิ่ม
            authorEntries[0].querySelector('.remove-author')?.remove();
            if (!authorEntries[0].querySelector('.add-author')) {
                authorEntries[0].querySelector('.author-actions').appendChild(createAddButton());
            }
        } else {
            // ถ้ามีมากกว่า 1 ช่อง ให้แสดงปุ่มเพิ่มสำหรับช่องสุดท้าย และปุ่มลบสำหรับทุกช่อง
            authorEntries.forEach((entry, index) => {
                const actionsDiv = entry.querySelector('.author-actions');
                
                // ลบปุ่มเดิมทั้งหมดก่อน
                actionsDiv.innerHTML = ''; 

                if (index === authorEntries.length - 1) {
                    actionsDiv.appendChild(createAddButton());
                }
                actionsDiv.appendChild(createRemoveButton());
            });
        }
    }

    // ตั้งค่าปุ่มผู้จัดทำเมื่อโหลดหน้าครั้งแรก
    document.addEventListener('DOMContentLoaded', checkAuthorButtons);

    // Upload Cover Image to Cloudinary
    coverImageInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) {
            uploadedImageUrlInput.value = '';
            coverImagePreview.classList.remove('visible'); /* ใช้ class 'visible' แทน 'hidden' */
            uploadedImageInfo = null;
            checkFormValidity();
            return;
        }

        if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET_IMAGE) {
            showImageUploadMessage('Cloudinary configuration missing. Please set CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET_IMAGE.', 'error');
            return;
        }

        showImageUploadMessage('กำลังอัปโหลดรูปภาพปก...', 'info');
        pendingFileUploads++;
        submitButton.disabled = true; // Disable submit button during upload

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET_IMAGE);

        try {
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData,
            });
            const data = await response.json();

            if (data.secure_url) {
                uploadedImageUrlInput.value = data.secure_url;
                uploadedImageDisplay.src = data.secure_url;
                imageUrlDisplay.textContent = data.secure_url;
                coverImagePreview.classList.add('visible'); /* ใช้ class 'visible' แทน 'hidden' */
                uploadedImageInfo = { url: data.secure_url, name: file.name, type: file.type };
                showImageUploadMessage('อัปโหลดรูปภาพปกสำเร็จ!', 'success');
            } else {
                uploadedImageUrlInput.value = '';
                coverImagePreview.classList.remove('visible'); /* ใช้ class 'visible' แทน 'hidden' */
                uploadedImageInfo = null;
                showImageUploadMessage(`อัปโหลดรูปภาพปกไม่สำเร็จ: ${data.error ? data.error.message : 'เกิดข้อผิดพลาดไม่ทราบสาเหตุ'}`, 'error');
                console.error('Cloudinary upload error:', data);
            }
        } catch (error) {
            uploadedImageUrlInput.value = '';
            coverImagePreview.classList.remove('visible'); /* ใช้ class 'visible' แทน 'hidden' */
            uploadedImageInfo = null;
            showImageUploadMessage(`อัปโหลดรูปภาพปกเกิดข้อผิดพลาด: ${error.message}`, 'error');
            console.error('Error uploading image to Cloudinary:', error);
        } finally {
            pendingFileUploads--;
            checkFormValidity(); // Re-check after upload
        }
    });

    // Upload Research Files to Cloudinary
    researchFileInput.addEventListener('change', async (event) => {
        const files = Array.from(event.target.files);
        if (files.length === 0) {
            uploadedResearchFilesUrlInput.value = JSON.stringify([]);
            researchFileListDiv.innerHTML = '';
            uploadedFileInfos = [];
            checkFormValidity();
            return;
        }

        if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET_FILES) {
            showFileUploadMessage('Cloudinary configuration missing for files. Please set CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET_FILES.', 'error');
            return;
        }

        uploadedFileInfos = []; // Reset previous files
        researchFileListDiv.innerHTML = ''; // Clear previous display
        showFileUploadMessage(`กำลังอัปโหลด ${files.length} ไฟล์...`, 'info');
        pendingFileUploads += files.length;
        submitButton.disabled = true; // Disable submit button during upload

        for (const file of files) {
            const fileItemDiv = document.createElement('div');
            fileItemDiv.classList.add('file-item'); /* ใช้ class 'file-item' แทน Tailwind classes */
            fileItemDiv.innerHTML = `
                <span class="file-name">${file.name}</span>
                <span class="file-status" id="status-${file.name.replace(/\./g, '-')}-${file.size}">กำลังอัปโหลด...</span>
            `;
            researchFileListDiv.appendChild(fileItemDiv);

            const statusSpan = document.getElementById(`status-${file.name.replace(/\./g, '-')}-${file.size}`);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET_FILES);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/raw/upload`, { // Use /raw/upload for non-image files
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (data.secure_url) {
                    uploadedFileInfos.push({
                        url: data.secure_url,
                        name: file.name,
                        type: file.type
                    });
                    statusSpan.textContent = 'อัปโหลดสำเร็จ!';
                    statusSpan.classList.add('text-green-600'); /* ใช้ class name */
                    statusSpan.classList.remove('text-gray-500'); /* ลบคลาสเดิม */
                } else {
                    statusSpan.textContent = `อัปโหลดไม่สำเร็จ: ${data.error ? data.error.message : 'ข้อผิดพลาดไม่ทราบสาเหตุ'}`;
                    statusSpan.classList.add('text-red-600'); /* ใช้ class name */
                    statusSpan.classList.remove('text-gray-500'); /* ลบคลาสเดิม */
                    console.error('Cloudinary file upload error:', data);
                }
            } catch (error) {
                statusSpan.textContent = `อัปโหลดเกิดข้อผิดพลาด: ${error.message}`;
                statusSpan.classList.add('text-red-600'); /* ใช้ class name */
                statusSpan.classList.remove('text-gray-500'); /* ลบคลาสเดิม */
                console.error('Error uploading file to Cloudinary:', error);
            } finally {
                pendingFileUploads--;
                uploadedResearchFilesUrlInput.value = JSON.stringify(uploadedFileInfos); // Update hidden input
                checkFormValidity(); // Re-check after each file upload
                if (pendingFileUploads === 0) {
                    if (uploadedFileInfos.length === files.length) {
                        showFileUploadMessage('อัปโหลดไฟล์งานวิจัยทั้งหมดสำเร็จ!', 'success');
                    } else if (uploadedFileInfos.length > 0) {
                        showFileUploadMessage('อัปโหลดไฟล์งานวิจัยบางส่วนสำเร็จ มีบางไฟล์ล้มเหลว', 'warning');
                    } else {
                        showFileUploadMessage('อัปโหลดไฟล์งานวิจัยไม่สำเร็จเลย โปรดลองอีกครั้ง', 'error');
                    }
                }
            }
        }
    });


    // Submit Form
    document.getElementById('research-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        hideFormMessage();
        submitButton.disabled = true; // Disable submit button to prevent double submission
        submitButton.textContent = 'กำลังส่งข้อมูล...';

        if (pendingFileUploads > 0) {
            showFormMessage('กรุณารอการอัปโหลดไฟล์และรูปภาพให้เสร็จสิ้นก่อน!', 'warning');
            submitButton.disabled = false;
            submitButton.textContent = 'ส่งข้อมูล';
            return;
        }

        const formData = new FormData(event.target);
        const data = {};

        // Collect authors as a comma-separated string
        const authors = Array.from(document.querySelectorAll('input[name="authors[]"]'))
                             .map(input => input.value.trim())
                             .filter(value => value !== '');
        data.authors = authors.join(', '); // Join with comma and space

        // Collect other form fields
        formData.forEach((value, key) => {
            if (key !== 'authors[]') { // Exclude authors[] from direct formData processing
                data[key] = value;
            }
        });

        // Add dynamically generated fields
        data.id = `RES_${Date.now()}`; // Unique ID for research
        data.timestamp = new Date().toLocaleString('th-TH'); // Current timestamp
        
        // Ensure image URL is from our uploaded state, not directly from input (which might be empty if no re-upload)
        data.coverImageUrl = uploadedImageUrlInput.value;
        // Ensure research file URLs are from our uploaded state
        data.researchFileUrls = uploadedResearchFilesUrlInput.value; 

        // Get current logged-in username from sessionStorage
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        data.username = loggedInUser ? loggedInUser.username : 'anonymous'; // Set username

        try {
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data).toString(),
            });
            const result = await response.json();

            if (result.success) {
                showFormMessage('ส่งข้อมูลงานวิจัยสำเร็จ! ข้อมูลของคุณจะถูกตรวจสอบโดยผู้ดูแลระบบ.', 'success');
                document.getElementById('research-form').reset(); // Clear form
                // Clear all dynamic fields/previews
                selectedCategoryInput.value = '';
                categoryItems.forEach(i => i.classList.remove('selected'));
                authorsContainer.innerHTML = ''; // Clear authors
                addAuthorField(); // Add back one author field
                uploadedImageUrlInput.value = '';
                coverImagePreview.classList.remove('visible'); // Remove 'visible' to hide
                uploadedImageInfo = null;
                researchFileInput.value = ''; // Clear file input
                uploadedResearchFilesUrlInput.value = JSON.stringify([]);
                researchFileListDiv.innerHTML = '';
                uploadedFileInfos = [];
            } else {
                showFormMessage(`ส่งข้อมูลไม่สำเร็จ: ${result.message}`, 'error');
            }
        } catch (error) {
            showFormMessage(`เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}`, 'error');
            console.error('Error submitting form:', error);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'ส่งข้อมูล';
            checkFormValidity(); // Re-check validity after submission attempt
        }
    });

    document.getElementById('cancel-btn').addEventListener('click', () => {
        // Optionally redirect or clear form
        if (confirm('คุณต้องการยกเลิกการอัปโหลดและล้างข้อมูลในฟอร์มใช่หรือไม่?')) {
            document.getElementById('research-form').reset();
            selectedCategoryInput.value = '';
            categoryItems.forEach(i => i.classList.remove('selected'));
            authorsContainer.innerHTML = '';
            addAuthorField(); // Add back one author field
            uploadedImageUrlInput.value = '';
            coverImagePreview.classList.remove('visible'); // Remove 'visible' to hide
            uploadedImageInfo = null;
            researchFileInput.value = '';
            uploadedResearchFilesUrlInput.value = JSON.stringify([]);
            researchFileListDiv.innerHTML = '';
            uploadedFileInfos = [];
            hideFormMessage();
            hideImageUploadMessage();
            hideFileUploadMessage();
            pendingFileUploads = 0; // Reset pending uploads
            checkFormValidity();
        }
    });

    // เรียกใช้ checkFormValidity เมื่อโหลดหน้าครั้งแรก เพื่อตั้งค่าปุ่ม submit เริ่มต้น
    document.addEventListener('DOMContentLoaded', () => {
        addAuthorField(); // เพิ่มช่องผู้จัดทำเริ่มต้น
        checkFormValidity(); 
    });

</script>
</body>
</html>
