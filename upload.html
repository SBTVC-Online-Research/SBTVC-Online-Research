<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>อัปโหลดผลงานวิจัย</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8 flex justify-center items-start min-h-screen">

    <div class="container bg-white p-8 rounded-lg shadow-md w-full max-w-2xl mt-8">
        <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">อัปโหลดผลงานวิจัยใหม่</h1>
        
        <div id="form-message" class="hidden p-3 mb-4 rounded-md text-sm font-medium" role="alert"></div>
        <div id="image-upload-message" class="hidden p-3 mb-4 rounded-md text-sm font-medium" role="alert"></div>
        <div id="file-upload-message" class="hidden p-3 mb-4 rounded-md text-sm font-medium" role="alert"></div>

        <form id="research-form">
            <div class="mb-4">
                <label for="title" class="block text-gray-700 text-sm font-bold mb-2">ชื่อผลงานวิจัย <span class="text-red-500">*</span></label>
                <input type="text" id="title" name="title" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">หมวดหมู่ <span class="text-red-500">*</span></label>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2">
                    <div class="category-item border border-gray-300 p-2 rounded-md text-center cursor-pointer hover:bg-gray-100 transition duration-200" data-value="บทความวิจัย">บทความวิจัย</div>
                    <div class="category-item border border-gray-300 p-2 rounded-md text-center cursor-pointer hover:bg-gray-100 transition duration-200" data-value="วิทยานิพนธ์">วิทยานิพนธ์</div>
                    <div class="category-item border border-gray-300 p-2 rounded-md text-center cursor-pointer hover:bg-gray-100 transition duration-200" data-value="สารนิพนธ์">สารนิพนธ์</div>
                    <div class="category-item border border-gray-300 p-2 rounded-md text-center cursor-pointer hover:bg-gray-100 transition duration-200" data-value="การศึกษาอิสระ">การศึกษาอิสระ</div>
                    <div class="category-item border border-gray-300 p-2 rounded-md text-center cursor-pointer hover:bg-gray-100 transition duration-200" data-value="งานวิจัยรับจ้าง">งานวิจัยรับจ้าง</div>
                    <div class="category-item border border-gray-300 p-2 rounded-md text-center cursor-pointer hover:bg-gray-100 transition duration-200" data-value="อื่นๆ">อื่นๆ</div>
                </div>
                <input type="hidden" id="selected-category" name="category" required>
            </div>

            <div class="mb-4">
                <label for="department" class="block text-gray-700 text-sm font-bold mb-2">สาขา <span class="text-red-500">*</span></label>
                <input type="text" id="department" name="department" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>

            <div class="mb-4">
                <label for="field" class="block text-gray-700 text-sm font-bold mb-2">กลุ่มวิชา/แขนงวิชา <span class="text-red-500">*</span></label>
                <input type="text" id="field" name="field" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="year" class="block text-gray-700 text-sm font-bold mb-2">ปีที่ทำ <span class="text-red-500">*</span></label>
                    <input type="number" id="year" name="year" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="academic-year" class="block text-gray-700 text-sm font-bold mb-2">ปีการศึกษา <span class="text-red-500">*</span></label>
                    <input type="text" id="academic-year" name="academicYear" placeholder="เช่น 2566/2567" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
            </div>

            <div class="mb-4">
                <label for="authors-container" class="block text-gray-700 text-sm font-bold mb-2">ผู้จัดทำ <span class="text-red-500">*</span></label>
                <div id="authors-container">
                    <div class="author-entry flex items-center mb-2">
                        <input type="text" name="authors[]" placeholder="ชื่อ-นามสกุล ผู้จัดทำ" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mr-2" required>
                        <div class="author-actions flex space-x-2">
                            </div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label for="advisor" class="block text-gray-700 text-sm font-bold mb-2">อาจารย์ที่ปรึกษา <span class="text-red-500">*</span></label>
                <input type="text" id="advisor" name="advisor" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>

            <div class="mb-4">
                <label for="abstract" class="block text-gray-700 text-sm font-bold mb-2">บทคัดย่อ <span class="text-red-500">*</span></label>
                <textarea id="abstract" name="abstract" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required></textarea>
            </div>

            <div class="mb-4">
                <label for="cover-image-input" class="block text-gray-700 text-sm font-bold mb-2">รูปภาพปกผลงานวิจัย <span class="text-red-500">*</span></label>
                <input type="file" id="cover-image-input" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <input type="hidden" id="uploaded-image-url" name="coverImageUrl">
                <div id="cover-image-preview" class="hidden mt-4 p-4 border border-gray-200 rounded-md text-center">
                    <img id="uploaded-image-display" src="" alt="Cover Image Preview" class="max-w-xs h-auto mx-auto mb-2 rounded-md shadow-sm">
                    <p class="text-gray-600 text-xs break-all">URL: <span id="image-url-display" class="font-semibold text-blue-600"></span></p>
                </div>
            </div>

            <div class="mb-6">
                <label for="research-file-input" class="block text-gray-700 text-sm font-bold mb-2">ไฟล์ผลงานวิจัย (.pdf, .doc, .docx, .ppt, .pptx) <span class="text-red-500">*</span></label>
                <input type="file" id="research-file-input" multiple accept=".pdf,.doc,.docx,.ppt,.pptx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <input type="hidden" id="uploaded-research-files-url" name="researchFileUrls">
                <div id="research-file-list" class="mt-4 space-y-2">
                    </div>
            </div>

            <div class="flex items-center justify-end mt-6 space-x-4">
                <button type="button" id="cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-200">
                    ยกเลิก
                </button>
                <button type="submit" id="submit-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ส่งข้อมูล
                </button>
            </div>
        </form>
    </div>

<script>
    // **สำคัญมาก: แทนที่ด้วย Web App URL ที่คุณ Deploy จาก Google Apps Script ของคุณ**
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-QTyfdSXqxmqVNoql7uRkoRZuGCHlZOJA-atzZT4ZEnIiLE_92v6dEm6iR3hBOzkp/exec'; 
    
    // Cloudinary Configuration (แทนที่ด้วย Cloud Name และ Preset ของคุณ)
    const CLOUDINARY_CLOUD_NAME = 'davuwvefc';
    const CLOUDINARY_UPLOAD_PRESET_IMAGE = 'STVC_preset'; // สำหรับรูปภาพปก
    const CLOUDINARY_UPLOAD_PRESET_FILES = 'STVC_preset'; // สำหรับไฟล์วิจัย (PDF, DOCX ฯลฯ)

    const formMessageDiv = document.getElementById('form-message');
    const imageUploadMessageDiv = document.getElementById('image-upload-message');
    const fileUploadMessageDiv = document.getElementById('file-upload-message');

    function showFormMessage(message, type = 'info') {
        formMessageDiv.textContent = message;
        formMessageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700', 'bg-yellow-100', 'text-yellow-700');
        if (type === 'error') {
            formMessageDiv.classList.add('bg-red-100', 'text-red-700');
        } else if (type === 'success') {
            formMessageDiv.classList.add('bg-green-100', 'text-green-700');
        } else if (type === 'info') {
            formMessageDiv.classList.add('bg-blue-100', 'text-blue-700');
        } else if (type === 'warning') {
            formMessageDiv.classList.add('bg-yellow-100', 'text-yellow-700');
        }
    }
    function hideFormMessage() {
        formMessageDiv.classList.add('hidden');
    }

    function showImageUploadMessage(message, type = 'info') {
        imageUploadMessageDiv.textContent = message;
        imageUploadMessageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700', 'bg-yellow-100', 'text-yellow-700');
        if (type === 'error') {
            imageUploadMessageDiv.classList.add('bg-red-100', 'text-red-700');
        } else if (type === 'success') {
            imageUploadMessageDiv.classList.add('bg-green-100', 'text-green-700');
        } else if (type === 'info') {
            imageUploadMessageDiv.classList.add('bg-blue-100', 'text-blue-700');
        } else if (type === 'warning') {
            imageUploadMessageDiv.classList.add('bg-yellow-100', 'text-yellow-700');
        }
    }
    function hideImageUploadMessage() {
        imageUploadMessageDiv.classList.add('hidden');
    }

    function showFileUploadMessage(message, type = 'info') {
        fileUploadMessageDiv.textContent = message;
        fileUploadMessageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700', 'bg-yellow-100', 'text-yellow-700');
        if (type === 'error') {
            fileUploadMessageDiv.classList.add('bg-red-100', 'text-red-700');
        } else if (type === 'success') {
            fileUploadMessageDiv.classList.add('bg-green-100', 'text-green-700');
        } else if (type === 'info') {
            fileUploadMessageDiv.classList.add('bg-blue-100', 'text-blue-700');
        } else if (type === 'warning') {
            fileUploadMessageDiv.classList.add('bg-yellow-100', 'text-yellow-700');
        }
    }
    function hideFileUploadMessage() {
        fileUploadMessageDiv.classList.add('hidden');
    }

    const categoryItems = document.querySelectorAll('.category-item');
    const selectedCategoryInput = document.getElementById('selected-category');
    const authorsContainer = document.getElementById('authors-container');
    const coverImageInput = document.getElementById('cover-image-input');
    const uploadedImageUrlInput = document.getElementById('uploaded-image-url');
    const coverImagePreview = document.getElementById('cover-image-preview');
    const uploadedImageDisplay = document.getElementById('uploaded-image-display');
    const imageUrlDisplay = document.getElementById('image-url-display');

    const researchFileInput = document.getElementById('research-file-input');
    const uploadedResearchFilesUrlInput = document.getElementById('uploaded-research-files-url');
    const researchFileListDiv = document.getElementById('research-file-list');

    let pendingFileUploads = 0; // ตัวนับไฟล์ที่กำลังอัปโหลด

    // ฟังก์ชันสำหรับควบคุมสถานะของปุ่ม Submit 
    function updateSubmitButtonState() { 
        const isImageUploaded = uploadedImageUrlInput.value !== ''; 
        const areFilesUploaded = JSON.parse(uploadedResearchFilesUrlInput.value || '[]').length > 0; 
         
        // ปุ่มจะถูกเปิดใช้งานถ้า: 
        // 1. มีการอัปโหลดรูปภาพปกแล้ว AND 
        // 2. มีการอัปโหลดไฟล์ผลงานวิจัยแล้ว AND 
        // 3. ไม่มีไฟล์ใดกำลังรออัปโหลด (pendingFileUploads === 0) 
        // 4. (อาจจะเพิ่มเงื่อนไขอื่นๆ เช่น ฟอร์มทั้งหมดผ่านการ validate เบื้องต้น) 
        document.getElementById('submit-btn').disabled = !(isImageUploaded && areFilesUploaded && pendingFileUploads === 0); 
    } 

    // เลือกหมวดหมู่
    categoryItems.forEach(item => {
        item.addEventListener('click', () => {
            categoryItems.forEach(i => i.classList.remove('bg-blue-500', 'text-white'));
            item.classList.add('bg-blue-500', 'text-white');
            selectedCategoryInput.value = item.dataset.value;
        });
    });

    // เพิ่ม/ลบผู้จัดทำ
    function createAddButton() {
        const button = document.createElement('button');
        button.type = 'button';
        button.classList.add('add-author', 'bg-green-500', 'hover:bg-green-700', 'text-white', 'py-1', 'px-2', 'rounded');
        button.textContent = 'เพิ่ม';
        button.addEventListener('click', addAuthorField);
        return button;
    }

    function createRemoveButton() {
        const button = document.createElement('button');
        button.type = 'button';
        button.classList.add('remove-author', 'bg-red-500', 'hover:bg-red-700', 'text-white', 'py-1', 'px-2', 'rounded');
        button.textContent = 'ลบ';
        button.addEventListener('click', function() {
            this.closest('.author-entry').remove();
            checkAuthorButtons();
        });
        return button;
    }

    function addAuthorField() {
        const div = document.createElement('div');
        div.classList.add('author-entry', 'flex', 'items-center', 'mb-2');
        div.innerHTML = `
            <input type="text" name="authors[]" placeholder="ชื่อ-นามสกุล ผู้จัดทำ" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mr-2" required>
            <div class="author-actions flex space-x-2"></div>
        `;
        const actionsDiv = div.querySelector('.author-actions');
        actionsDiv.appendChild(createAddButton());
        actionsDiv.appendChild(createRemoveButton());
        authorsContainer.appendChild(div);
        checkAuthorButtons();
    }

    function checkAuthorButtons() {
        const authorEntries = authorsContainer.querySelectorAll('.author-entry');
        if (authorEntries.length === 1) {
            // ถ้ามีเพียงช่องเดียว ให้แสดงเฉพาะปุ่มเพิ่ม
            authorEntries[0].querySelector('.remove-author').remove();
            if (!authorEntries[0].querySelector('.add-author')) {
                authorEntries[0].querySelector('.author-actions').appendChild(createAddButton());
            }
        } else {
            // ถ้ามีมากกว่า 1 ช่อง ให้แสดงปุ่มเพิ่มสำหรับช่องสุดท้าย และปุ่มลบสำหรับทุกช่อง
            authorEntries.forEach((entry, index) => {
                const actionsDiv = entry.querySelector('.author-actions');
                
                // ลบปุ่มเดิมทั้งหมดก่อน
                actionsDiv.innerHTML = ''; 

                if (index === authorEntries.length - 1) {
                    actionsDiv.appendChild(createAddButton());
                }
                actionsDiv.appendChild(createRemoveButton());
            });
        }
    }

    // ตั้งค่าปุ่มผู้จัดทำเมื่อโหลดหน้าครั้งแรก
    document.addEventListener('DOMContentLoaded', addAuthorField); // Add initial author field on load
    document.addEventListener('DOMContentLoaded', checkAuthorButtons);

    // Upload Cover Image to Cloudinary
    coverImageInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) {
            uploadedImageUrlInput.value = '';
            coverImagePreview.classList.add('hidden');
            updateSubmitButtonState();
            return;
        }

        if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET_IMAGE) {
            showImageUploadMessage('Cloudinary configuration missing. Please set CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET_IMAGE.', 'error');
            return;
        }

        showImageUploadMessage('กำลังอัปโหลดรูปภาพปก...', 'info');
        pendingFileUploads++;
        updateSubmitButtonState();
        coverImageInput.disabled = true; // ปิดการใช้งาน input ระหว่างอัปโหลด

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET_IMAGE);

        try {
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData,
            });
            const data = await response.json();

            if (data.secure_url) {
                uploadedImageUrlInput.value = data.secure_url;
                uploadedImageDisplay.src = data.secure_url;
                imageUrlDisplay.textContent = data.secure_url;
                coverImagePreview.classList.remove('hidden');
                showImageUploadMessage('อัปโหลดรูปภาพปกสำเร็จ!', 'success');
            } else {
                uploadedImageUrlInput.value = '';
                coverImagePreview.classList.add('hidden');
                showImageUploadMessage(`อัปโหลดรูปภาพปกไม่สำเร็จ: ${data.error ? data.error.message : 'ไม่ทราบข้อผิดพลาด'}`, 'error');
                console.error('Cloudinary upload error:', data);
            }
        } catch (error) {
            uploadedImageUrlInput.value = '';
            coverImagePreview.classList.add('hidden');
            showImageUploadMessage(`เกิดข้อผิดพลาดในการอัปโหลดรูปภาพปก: ${error.message}`, 'error');
            console.error('Error uploading image to Cloudinary:', error);
        } finally {
            pendingFileUploads--;
            coverImageInput.disabled = false; // เปิดใช้งาน input กลับมา
            updateSubmitButtonState();
        }
    });

    // Upload Research Files to Cloudinary
    researchFileInput.addEventListener('change', async (event) => {
        const files = Array.from(event.target.files);
        if (files.length === 0) {
            uploadedResearchFilesUrlInput.value = JSON.stringify([]);
            researchFileListDiv.innerHTML = ''; // เคลียร์รายการไฟล์
            updateSubmitButtonState();
            return;
        }

        if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET_FILES) {
            showFileUploadMessage('Cloudinary configuration missing for files. Please set CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET_FILES.', 'error');
            return;
        }

        researchFileListDiv.innerHTML = ''; // Clear previous file list
        let uploadedFileUrls = [];
        showFileUploadMessage(`กำลังอัปโหลด ${files.length} ไฟล์...`, 'info');
        researchFileInput.disabled = true; // ปิดการใช้งาน input ระหว่างอัปโหลด

        for (const file of files) {
            const fileDiv = document.createElement('div');
            fileDiv.textContent = `⏳ ${file.name} - กำลังอัปโหลด...`;
            researchFileListDiv.appendChild(fileDiv);

            pendingFileUploads++;
            updateSubmitButtonState(); // อัปเดตสถานะปุ่ม Submit

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET_FILES); // ใช้ preset สำหรับไฟล์

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/raw/upload`, { // ใช้ /raw/upload สำหรับไฟล์ที่ไม่ใช่รูปภาพ
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (data.secure_url) {
                    uploadedFileUrls.push({ url: data.secure_url, name: file.name, type: file.type });
                    fileDiv.textContent = `✅ ${file.name} - อัปโหลดสำเร็จ!`;
                    fileDiv.classList.add('text-green-700');
                } else {
                    fileDiv.textContent = `❌ ${file.name} - อัปโหลดไม่สำเร็จ: ${data.error ? data.error.message : 'ไม่ทราบข้อผิดพลาด'}`;
                    fileDiv.classList.add('text-red-700');
                    showFileUploadMessage('มีบางไฟล์อัปโหลดไม่สำเร็จ', 'error');
                }
            } catch (error) {
                console.error('Cloudinary file upload error:', error);
                fileDiv.textContent = `❌ ${file.name} - เกิดข้อผิดพลาดในการอัปโหลดไฟล์`;
                fileDiv.classList.add('text-red-700');
                showFileUploadMessage('เกิดข้อผิดพลาดในการอัปโหลดไฟล์', 'error');
            } finally {
                pendingFileUploads--;
                if (pendingFileUploads === 0) {
                    uploadedResearchFilesUrlInput.value = JSON.stringify(uploadedFileUrls); 
                    if (uploadedFileUrls.length === researchFileInput.files.length) { 
                        showFileUploadMessage(`อัปโหลดไฟล์ผลงานวิจัย ${uploadedFileUrls.length} ไฟล์สำเร็จ!`, 'success'); 
                    } else if (uploadedFileUrls.length > 0) { 
                        showFileUploadMessage(`อัปโหลดไฟล์บางส่วนสำเร็จ (${uploadedFileUrls.length}/${researchFileInput.files.length} ไฟล์)`, 'info'); 
                    } else { 
                        showFileUploadMessage('ไม่มีไฟล์ใดอัปโหลดสำเร็จ', 'error'); 
                    } 
                    researchFileInput.disabled = false; 
                    updateSubmitButtonState(); 
                } 
            } 
        } 
    }); 

    // ปุ่มยกเลิก 
    document.getElementById('cancel-btn').addEventListener('click', () => { 
        if(confirm('ต้องการยกเลิกและล้างข้อมูลทั้งหมดหรือไม่?')) { 
            document.getElementById('research-form').reset(); 
            categoryItems.forEach(i => i.classList.remove('selected', 'bg-blue-500', 'text-white')); // Remove Tailwind classes too 
            selectedCategoryInput.value = ''; 
            
            // ลบผู้จัดทำที่เพิ่มเข้ามา ให้เหลือแค่คนแรกพร้อมปุ่มเพิ่ม 
            const authors = authorsContainer.querySelectorAll('.author-entry'); 
            authors.forEach((author, idx) => { 
                if(idx > 0) author.remove(); 
            }); 
            // ตรวจสอบให้แน่ใจว่าผู้แต่งคนแรกมีปุ่มเพิ่ม 
            const firstAuthorEntry = authorsContainer.querySelector('.author-entry'); 
            if (firstAuthorEntry && !firstAuthorEntry.querySelector('.add-author')) { 
                const removeBtn = firstAuthorEntry.querySelector('.remove-author'); 
                if (removeBtn) removeBtn.replaceWith(createAddButton()); 
            } 
            firstAuthorEntry.querySelector('input[name="authors[]"]').value = ''; // Clear first author input

            // เคลียร์สถานะการอัปโหลดไฟล์และรูปภาพ 
            uploadedImageUrlInput.value = ''; 
            coverImagePreview.classList.add('hidden'); 
            uploadedImageDisplay.src = ''; // เคลียร์รูปภาพใน preview 
            imageUrlDisplay.textContent = ''; 
            
            uploadedResearchFilesUrlInput.value = ''; 
            researchFileListDiv.innerHTML = ''; 
            researchFileInput.value = ''; // เคลียร์ไฟล์ที่เลือกใน input 
            coverImageInput.value = ''; // เคลียร์ไฟล์ที่เลือกใน input 

            hideFormMessage(); 
            hideImageUploadMessage(); 
            hideFileUploadMessage(); 
            pendingFileUploads = 0; // รีเซ็ตตัวนับการอัปโหลดที่รอดำเนินการ 
            updateSubmitButtonState(); // Ensure submit button is updated after cancel 
        } 
    }); 

    // ส่งข้อมูลทั้งหมดไปยัง Google Apps Script Web App 
    document.getElementById('research-form').addEventListener('submit', async (e) => { 
        e.preventDefault(); 

        // ตรวจสอบความถูกต้องของข้อมูล (Required fields) 
        if (!document.getElementById('title').value || 
            !selectedCategoryInput.value || 
            !document.getElementById('department').value || 
            !document.getElementById('field').value || 
            !document.getElementById('year').value || 
            !document.getElementById('academic-year').value || 
            !document.getElementById('advisor').value || 
            !document.getElementById('abstract').value) { 
            showFormMessage('กรุณากรอกข้อมูลให้ครบถ้วนทุกช่องที่มีเครื่องหมาย *', 'error'); 
            return; 
        } 

        const authorsInputs = document.querySelectorAll('input[name="authors[]"]'); 
        let allAuthorsFilled = true; 
        authorsInputs.forEach(input => { 
            if (input.value.trim() === '') { 
                allAuthorsFilled = false; 
            } 
        }); 
        if (!allAuthorsFilled) { 
            showFormMessage('กรุณากรอกชื่อผู้จัดทำให้ครบถ้วน', 'error'); 
            return; 
        } 

        // ตรวจสอบว่าอัปโหลดรูปภาพปกแล้ว 
        if (!uploadedImageUrlInput.value) { 
            showFormMessage('กรุณาอัปโหลดรูปภาพปกผลงานวิจัย', 'error'); 
            return; 
        } 
        // ตรวจสอบว่าอัปโหลดไฟล์ผลงานวิจัยแล้ว 
        let researchFileUrls = []; 
        try { 
            researchFileUrls = JSON.parse(uploadedResearchFilesUrlInput.value || '[]'); 
        } catch (e) { 
            showFormMessage('ข้อมูล URL ไฟล์ผลงานวิจัยไม่ถูกต้อง', 'error'); 
            return; 
        } 
        if (researchFileUrls.length === 0) { 
            showFormMessage('กรุณาอัปโหลดไฟล์ผลงานวิจัย', 'error'); 
            return; 
        } 
        if (pendingFileUploads > 0) { 
            showFormMessage('กำลังอัปโหลดไฟล์บางส่วน กรุณารอสักครู่', 'info'); 
            return; 
        } 

        showFormMessage('กำลังส่งข้อมูล... กรุณารอสักครู่', 'info'); 
        document.getElementById('submit-btn').disabled = true; 

        // รวบรวมข้อมูลทั้งหมดในรูปแบบ FormData 
        const formData = new FormData(); 
        formData.append('action', 'submitResearch'); 
        formData.append('id', `res-${Date.now()}-${Math.floor(Math.random() * 1000000)}`); 
        formData.append('title', document.getElementById('title').value); 
        formData.append('category', selectedCategoryInput.value); 
        formData.append('department', document.getElementById('department').value); 
        formData.append('field', document.getElementById('field').value); 
        formData.append('year', document.getElementById('year').value); 
        formData.append('academicYear', document.getElementById('academic-year').value); 
        formData.append('authors', Array.from(document.querySelectorAll('input[name="authors[]"]')).map(input => input.value.trim()).filter(Boolean).join(', ')); 
        formData.append('advisor', document.getElementById('advisor').value); 
        formData.append('abstract', document.getElementById('abstract').value); 
        formData.append('coverImageUrl', uploadedImageUrlInput.value); 
        formData.append('researchFileUrls', JSON.stringify(researchFileUrls)); 
        formData.append('timestamp', new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })); 

        try { 
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL, { 
                method: 'POST', 
                body: formData, 
            }); 

            const result = await response.json(); 

            if (result.status === 'success') { 
                showFormMessage('ส่งข้อมูลผลงานวิจัยสำเร็จแล้ว! ข้อมูลจะถูกตรวจสอบและอนุมัติโดยผู้ดูแลระบบ', 'success'); 
                // ล้างฟอร์มทั้งหมด 
                document.getElementById('research-form').reset(); 
                categoryItems.forEach(i => i.classList.remove('selected', 'bg-blue-500', 'text-white')); 
                selectedCategoryInput.value = ''; 
                
                // Reset ผู้จัดทำ 
                const authorsElements = authorsContainer.querySelectorAll('.author-entry'); 
                authorsElements.forEach((author, idx) => { 
                    if(idx > 0) author.remove(); 
                }); 
                const firstAuthorInput = authorsContainer.querySelector('input[name="authors[]"]'); 
                if (firstAuthorInput) firstAuthorInput.value = ''; 
                const soleAuthorEntry = authorsContainer.querySelector('.author-entry'); 
                const removeButton = soleAuthorEntry.querySelector('.remove-author'); 
                if (removeButton) { 
                    removeButton.replaceWith(createAddButton()); 
                } 

                uploadedImageUrlInput.value = ''; 
                coverImagePreview.classList.add('hidden'); 
                uploadedImageDisplay.src = ''; 
                imageUrlDisplay.textContent = ''; 
                
                uploadedResearchFilesUrlInput.value = ''; 
                researchFileListDiv.innerHTML = ''; 
                researchFileInput.value = ''; 
                coverImageInput.value = ''; 

                hideImageUploadMessage(); 
                hideFileUploadMessage(); 
            } else { 
                showFormMessage(`เกิดข้อผิดพลาด: ${result.message || 'ไม่สามารถส่งข้อมูลได้'}`, 'error'); 
            } 
        } catch (error) { 
            console.error('Error submitting research to Google Apps Script:', error); 
            showFormMessage('เกิดข้อผิดพลาดในการเชื่อมต่อกับ Apps Script', 'error'); 
        } finally { 
            document.getElementById('submit-btn').disabled = false; 
            setTimeout(() => { 
                hideFormMessage(); 
            }, 7000); 
        } 
    }); 
</script> 

</body> 
</html>
