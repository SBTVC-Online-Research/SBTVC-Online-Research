<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบอัปโหลดผลงานวิจัย</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #f0f4f8;
    }
    .upload-box-file {
      border: 2px dashed hsl(27, 93%, 49%);
      transition: all 0.3s ease;
    }
    .upload-box-file:hover {
      border-color: #db7c0ed5;
      background-color: rgba(231, 134, 23, 0.89);
    }
    .category-item {
      transition: all 0.2s ease;
    }
    .category-item:hover {
      transform: translateY(-2px);
      border-color: #28a745;
    }
    .category-item.selected {
      border-color: #136b27;
      background-color: #28a745;
      color: white;
    }
    .message {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        text-align: center;
    }
    .message.success {
        background-color: #d1fae5; /* green-100 */
        color: #065f46; /* green-800 */
    }
    .message.error {
        background-color: #fee2e2; /* red-100 */
        color: #991b1b; /* red-800 */
    }
    .message.info {
        background-color: #e0f2fe; /* blue-100 */
        color: #1e40af; /* blue-800 */
    }
  </style>
</head>
<body>

<header class="bg-gradient-to-r from-orange-600 to-orange-600 text-white py-6 shadow-lg">
  <div class="container mx-auto px-4">
    <h1 class="text-3xl font-bold">ระบบอัปโหลดผลงานวิจัย</h1>
    <p class="mt-2 text-orange-100">อัปโหลดและจัดการผลงานวิจัยของคุณได้อย่างง่ายดาย</p>
  </div>
</header>

<main class="container mx-auto px-4 py-8">
  <div class="flex justify-end mb-4">
    <a href="index.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
      ← กลับหน้าหลัก
    </a>
  </div>

  <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6">อัปโหลดผลงานวิจัยใหม่</h2>
    <form id="research-form">
      <div class="mb-6">
        <label for="title" class="block text-gray-700 font-medium mb-2">ชื่อผลงานวิจัย <span class="text-red-500">*</span></label>
        <input type="text" id="title" name="title" class="w-full px-4 py-2 border rounded-lg focus:ring-orange-500 focus:border-orange-500 outline-none" required>
      </div>

      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2">หมวดหมู่ <span class="text-red-500">*</span></label>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="category-item border p-4 rounded-lg text-center cursor-pointer" data-category="survey">สำรวจ</div>
          <div class="category-item border p-4 rounded-lg text-center cursor-pointer" data-category="theory">ทฤษฎี</div>
          <div class="category-item border p-4 rounded-lg text-center cursor-pointer" data-category="experiment">ทดลอง</div>
          <div class="category-item border p-4 rounded-lg text-center cursor-pointer" data-category="invention">ประดิษฐ์</div>
        </div>
        <input type="hidden" id="selected-category" name="category" required>
      </div>

      
        <div>
          <label for="department" class="block text-gray-700 font-medium mb-2">สาขาวิชา <span class="text-red-500">*</span></label>
          <select id="department" name="department" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500" required>
            <option value="" disabled selected>เลือกแผนกวิชา</option>
            <option value="computer">เทคโนโลยีคอมพิวเตอร์</option>
            <option value="accounting">เมคคาทรอนิค</option>
            <option value="marketing">ไฟฟ้ากำลัง</option>
            <option value="electronics">อิเล็กทรอนิกส์</option>
            <option value="mechanics">เครื่องมือกล</option>
            <option value="mechanics">เครื่องกล</option>
            <option value="mechanics">เทคนิคพื้นฐาน</option>
            <option value="mechanics">สามัญสัมพันธ์</option>
            <option value="mechanics">ช่างอุสาหกรรมฐานวิทย์ศาสตร์</option>
          </select>
        </div>
        <div>
        <br>
        </div>
      

      <div class="grid md:grid-cols-2 gap-6 mb-6">
        <div>
          <label for="year" class="block text-gray-700 font-medium mb-2">ชั้นปี <span class="text-red-500">*</span></label>
          <select id="year" name="year" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500" required>
            <option value="" disabled selected>เลือกชั้นปี</option>
            <option>ปวช.1</option><option>ปวช.2</option><option>ปวช.3</option>
            <option>ปวส.1</option><option>ปวส.2</option>
          </select>
        </div>
        <div>
          <label for="academic-year" class="block text-gray-700 font-medium mb-2">ปีการศึกษา <span class="text-red-500">*</span></label>
          <select id="academic-year" name="academicYear" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500" required>
            <option value="" disabled selected>เลือกปีการศึกษา</option>
            <option>2567</option><option>2566</option><option>2565</option><option>2564</option><option>2563</option><option>2562</option><option>2561</option><option>2560</option><option>2559</option><option>2558</option><option>2557</option><option>2556</option><option>2555</option><option>2554</option><option>2553</option><option>2552</option><option>2551</option><option>2550</option><option>2549</option><option>2548</option><option>2547</option><option>2546</option><option>2545</option><option>2544</option><option>2543</option><option>2542</option><option>2541</option>
          </select>
        </div>
      </div>

      <div class="mb-6">
        <label class="block text-gray-700 font-medium mb-2">ชื่อผู้จัดทำ <span class="text-red-500">*</span></label>
        <div id="authors-container">
          <div class="author-entry flex items-center gap-4 mb-2">
            <input type="text" name="authors[]" class="flex-1 border rounded-lg px-4 py-2 focus:ring-blue-500" placeholder="ชื่อ-นามสกุล" required>
            <button type="button" class="add-author bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600">
              ＋
            </button>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <label for="advisor" class="block text-gray-700 font-medium mb-2">อาจารย์ที่ปรึกษา <span class="text-red-500">*</span></label>
        <input type="text" id="advisor" name="advisor" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500" required>
      </div>

      <div class="mb-6">
        <label for="abstract" class="block text-gray-700 font-medium mb-2">บทคัดย่อ <span class="text-red-500">*</span></label>
        <textarea id="abstract" name="abstract" rows="4" class="w-full border rounded-lg px-4 py-2 focus:ring-blue-500" required></textarea>
      </div>

      <div class="mb-8">
        <label class="block text-gray-700 font-medium mb-2">อัปโหลดรูปภาพปกผลงาน (ไม่เกิน 5MB) <span class="text-red-500">*</span></label>
        <div class="upload-box-file bg-gray-50 rounded-lg p-8 text-center cursor-pointer">
          <input type="file" id="cover-image-upload" class="hidden" accept="image/*">
          <div>
            <svg class="h-12 w-12 mx-auto text-orange-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/></svg>
          </div>
          <p class="font-medium text-gray-700">ลากรูปภาพหรือคลิกเพื่อเลือก</p>
          <p class="text-sm text-gray-500">รองรับ: JPG, PNG, GIF (สูงสุด 5MB/ไฟล์)</p>
        </div>
        <div id="cover-image-preview" class="mt-4 text-center hidden">
            <img id="uploaded-image-display" src="" alt="รูปภาพปก" class="max-w-xs mx-auto rounded-lg shadow-md mb-2">
            <p id="image-url-display" class="text-sm text-blue-600 truncate"></p>
        </div>
        <input type="hidden" id="uploaded-image-url" name="coverImageUrl">
        <div id="image-upload-message" class="message hidden"></div>
      </div>

      <div class="mb-8">
        <label class="block text-gray-700 font-medium mb-2">อัปโหลดไฟล์ผลงานวิจัย (PDF/DOC/DOCX) <span class="text-red-500">*</span></label>
        <div class="upload-box-file bg-gray-50 rounded-lg p-8 text-center cursor-pointer">
          <input type="file" id="research-file-upload" class="hidden" multiple accept=".pdf,.doc,.docx">
          <div>
            <svg class="h-12 w-12 mx-auto text-orange-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/></svg>
          </div>
          <p class="font-medium text-gray-700">ลากไฟล์หรือคลิกเพื่อเลือก</p>
          <p class="text-sm text-gray-500">รองรับ: PDF, DOC, DOCX (สูงสุด 10MB/ไฟล์)</p>
        </div>
        <div id="research-file-list" class="mt-4 space-y-2"></div>
        <input type="hidden" id="uploaded-research-files-url" name="researchFileUrls">
        <div id="file-upload-message" class="message hidden"></div>
      </div>

      <div id="form-message" class="message hidden"></div>
      <div class="flex justify-end">
        <button type="button" id="cancel-btn" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 mr-4">ยกเลิก</button>
        <button type="submit" id="submit-btn" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">อัปโหลด</button>
      </div>
    </form>
  </div>
</main>

<script>
  // **Cloudinary Configuration** (เปลี่ยนเป็น Cloud name และ Upload preset ของคุณ)
  const CLOUDINARY_CLOUD_NAME = 'davuwvefc'; // <-- เปลี่ยนตรงนี้เป็น Cloud name ของคุณ
  const CLOUDINARY_IMAGE_UPLOAD_PRESET = 'STVC_preset'; // <-- เปลี่ยนตรงนี้ (ตั้งชื่อใหม่ เช่น research_photo_preset)
  const CLOUDINARY_FILE_UPLOAD_PRESET = 'STVC_preset'; // <-- เปลี่ยนตรงนี้ (ตั้งชื่อใหม่ เช่น research_file_preset)

  // **Google Apps Script Web App URL** //
  // *** สำคัญมาก: URL ของคุณถูกนำมาใช้ที่นี่แล้ว ***
  const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-QTyfdSXqxmqVNoql7uRkoRZuGCHlZOJA-atzZT4ZEnIiLE_92v6dEm6iR3hBOzkp/exec'; 

  // เลือกหมวดหมู่
  const categoryItems = document.querySelectorAll('.category-item');
  const selectedCategoryInput = document.getElementById('selected-category');

  categoryItems.forEach(item => {
    item.addEventListener('click', () => {
      categoryItems.forEach(i => i.classList.remove('selected'));
      item.classList.add('selected');
      selectedCategoryInput.value = item.dataset.category;
    });
  });

  // เพิ่ม/ลบรายชื่อผู้จัดทำ
  const authorsContainer = document.getElementById('authors-container');
  authorsContainer.addEventListener('click', e => {
    if(e.target.classList.contains('add-author')) {
      const newAuthorDiv = document.createElement('div');
      newAuthorDiv.className = 'author-entry flex items-center gap-4 mb-2';
      newAuthorDiv.innerHTML = `
        <input type="text" name="authors[]" class="flex-1 border rounded-lg px-4 py-2 focus:ring-blue-500" placeholder="ชื่อ-นามสกุล" required>
        <button type="button" class="remove-author bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600">－</button>
      `;
      authorsContainer.appendChild(newAuthorDiv);
    }
    if(e.target.classList.contains('remove-author')) {
      e.target.parentElement.remove();
    }
  });

  // ฟังก์ชันแสดงข้อความ
  const formMessage = document.getElementById('form-message');
  function showFormMessage(msg, type) {
      formMessage.textContent = msg;
      formMessage.className = `message ${type}`;
      formMessage.classList.remove('hidden');
  }
  function hideFormMessage() {
      formMessage.classList.add('hidden');
      formMessage.textContent = '';
  }

  const imageUploadMessage = document.getElementById('image-upload-message');
  function showImageUploadMessage(msg, type) {
      imageUploadMessage.textContent = msg;
      imageUploadMessage.className = `message ${type}`;
      imageUploadMessage.classList.remove('hidden');
  }
  function hideImageUploadMessage() {
      imageUploadMessage.classList.add('hidden');
      imageUploadMessage.textContent = '';
  }

  const fileUploadMessage = document.getElementById('file-upload-message');
  function showFileUploadMessage(msg, type) {
      fileUploadMessage.textContent = msg;
      fileUploadMessage.className = `message ${type}`;
      fileUploadMessage.classList.remove('hidden');
  }
  function hideFileUploadMessage() {
      fileUploadMessage.classList.add('hidden');
      fileUploadMessage.textContent = '';
  }

  // --- การจัดการอัปโหลดรูปภาพปก (Cover Image) ไปยัง Cloudinary ---
  const coverImageUploadBox = document.querySelector('#cover-image-upload').parentElement;
  const coverImageInput = document.getElementById('cover-image-upload');
  const coverImagePreview = document.getElementById('cover-image-preview');
  const uploadedImageDisplay = document.getElementById('uploaded-image-display');
  const imageUrlDisplay = document.getElementById('image-url-display');
  const uploadedImageUrlInput = document.getElementById('uploaded-image-url'); // Hidden input to store URL

  coverImageUploadBox.addEventListener('click', () => coverImageInput.click());

  coverImageInput.addEventListener('change', async () => {
    const file = coverImageInput.files[0];
    if (!file) {
      uploadedImageUrlInput.value = '';
      coverImagePreview.classList.add('hidden');
      hideImageUploadMessage();
      return;
    }

    if (file.size > 5 * 1024 * 1024) { // 5MB limit
      showImageUploadMessage('ขนาดรูปภาพต้องไม่เกิน 5MB', 'error');
      coverImageInput.value = ''; // Clear selected file
      coverImagePreview.classList.add('hidden');
      uploadedImageUrlInput.value = '';
      return;
    }

    showImageUploadMessage('กำลังอัปโหลดรูปภาพ...', 'info');
    document.getElementById('submit-btn').disabled = true; // Disable submit during upload
    coverImageInput.disabled = true; // ปิดปุ่มอัปโหลดชั่วคราว
    uploadedImageUrlInput.value = ''; // เคลียร์ URL เก่า
    coverImagePreview.classList.add('hidden'); // ซ่อน preview เก่า

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_IMAGE_UPLOAD_PRESET);
    formData.append('resource_type', 'image');

    try {
      const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
        method: 'POST',
        body: formData,
      });
      const data = await response.json();

      if (data.secure_url) {
        uploadedImageDisplay.src = data.secure_url;
        imageUrlDisplay.textContent = data.secure_url;
        uploadedImageUrlInput.value = data.secure_url; // เก็บ URL ใน hidden input
        coverImagePreview.classList.remove('hidden');
        showImageUploadMessage('อัปโหลดรูปภาพสำเร็จ!', 'success');
      } else {
        showImageUploadMessage(`อัปโหลดรูปภาพล้มเหลว: ${data.error.message || 'ไม่ทราบข้อผิดพลาด'}`, 'error');
        coverImagePreview.classList.add('hidden');
      }
    } catch (error) {
      console.error('Cloudinary image upload error:', error);
      showImageUploadMessage('เกิดข้อผิดพลาดในการอัปโหลดรูปภาพ', 'error');
      coverImagePreview.classList.add('hidden');
    } finally {
      coverImageInput.disabled = false;
      // Re-enable submit button only if both image and file are ready (or not required yet)
      document.getElementById('submit-btn').disabled = false; 
    }
  });


  // --- การจัดการอัปโหลดไฟล์ผลงานวิจัย (PDF/DOCX) ไปยัง Cloudinary ---
  const researchFileUploadBox = document.querySelector('#research-file-upload').parentElement;
  const researchFileInput = document.getElementById('research-file-upload');
  const researchFileListDiv = document.getElementById('research-file-list');
  const uploadedResearchFilesUrlInput = document.getElementById('uploaded-research-files-url'); // Hidden input for file URLs

  researchFileUploadBox.addEventListener('click', () => researchFileInput.click());

  researchFileInput.addEventListener('change', async () => {
    researchFileListDiv.innerHTML = '';
    uploadedResearchFilesUrlInput.value = ''; // Clear old URLs
    const uploadedFileUrls = [];

    if (researchFileInput.files.length === 0) {
      showFileUploadMessage('กรุณาเลือกไฟล์สำหรับอัปโหลด', 'info');
      return;
    }

    showFileUploadMessage('กำลังอัปโหลดไฟล์ผลงานวิจัย...', 'info');
    document.getElementById('submit-btn').disabled = true; // Disable submit during upload
    researchFileInput.disabled = true; // Disable input during upload

    for (const file of researchFileInput.files) {
      if (file.size > 10 * 1024 * 1024) { // 10MB limit
        showFileUploadMessage(`ไฟล์ "${file.name}" มีขนาดเกิน 10MB กรุณาเลือกไฟล์ใหม่`, 'error');
        researchFileInput.value = ''; // Clear all selected files
        researchFileListDiv.innerHTML = '';
        researchFileInput.disabled = false;
        // Re-enable submit button
        document.getElementById('submit-btn').disabled = false;
        return;
      }
      const fileDiv = document.createElement('div');
      fileDiv.textContent = `⏳ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB) - กำลังอัปโหลด...`;
      fileDiv.className = 'text-gray-700';
      researchFileListDiv.appendChild(fileDiv);

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', CLOUDINARY_FILE_UPLOAD_PRESET); // ใช้ preset สำหรับไฟล์เอกสาร

      try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
          method: 'POST',
          body: formData,
        });
        const data = await response.json();

        if (data.secure_url) {
          uploadedFileUrls.push(data.secure_url);
          fileDiv.textContent = `✅ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB) - อัปโหลดสำเร็จ`;
          fileDiv.classList.add('text-green-700');
        } else {
          fileDiv.textContent = `❌ ${file.name} - อัปโหลดล้มเหลว: ${data.error.message || 'ไม่ทราบข้อผิดพลาด'}`;
          fileDiv.classList.add('text-red-700');
          showFileUploadMessage('มีบางไฟล์อัปโหลดล้มเหลว', 'error');
          researchFileInput.disabled = false;
          // Re-enable submit button
          document.getElementById('submit-btn').disabled = false;
          return;
        }
      } catch (error) {
        console.error('Cloudinary file upload error:', error);
        fileDiv.textContent = `❌ ${file.name} - เกิดข้อผิดพลาดในการอัปโหลดไฟล์`;
        fileDiv.classList.add('text-red-700');
        showFileUploadMessage('เกิดข้อผิดพลาดในการอัปโหลดไฟล์', 'error');
        researchFileInput.disabled = false;
        // Re-enable submit button
        document.getElementById('submit-btn').disabled = false;
        return;
      }
    }
    uploadedResearchFilesUrlInput.value = JSON.stringify(uploadedFileUrls); // เก็บ URL ทั้งหมดใน hidden input
    showFileUploadMessage(`อัปโหลดไฟล์ผลงานวิจัย ${uploadedFileUrls.length} ไฟล์สำเร็จ!`, 'success');
    researchFileInput.disabled = false;
    // Re-enable submit button
    document.getElementById('submit-btn').disabled = false;
  });


  // ปุ่มยกเลิก
  document.getElementById('cancel-btn').addEventListener('click', () => {
    if(confirm('ต้องการยกเลิกและล้างข้อมูลทั้งหมดหรือไม่?')) {
      document.getElementById('research-form').reset();
      categoryItems.forEach(i => i.classList.remove('selected'));
      selectedCategoryInput.value = '';
      // ลบผู้จัดทำเกินอันแรก
      const authors = authorsContainer.querySelectorAll('.author-entry');
      authors.forEach((author, idx) => {
        if(idx > 0) author.remove();
      });
      // เคลียร์สถานะการอัปโหลดไฟล์และรูปภาพ
      uploadedImageUrlInput.value = '';
      coverImagePreview.classList.add('hidden');
      imageUrlDisplay.textContent = ''; // Clear image URL text
      uploadedResearchFilesUrlInput.value = '';
      researchFileListDiv.innerHTML = '';
      hideFormMessage(); 
      hideImageUploadMessage();
      hideFileUploadMessage();
      document.getElementById('submit-btn').disabled = false; // Ensure submit button is enabled after cancel
    }
  });

  // ส่งข้อมูลทั้งหมดไปยัง Google Apps Script Web App
  document.getElementById('research-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // ตรวจสอบว่าเลือกหมวดหมู่
    if (!selectedCategoryInput.value) {
      showFormMessage('กรุณาเลือกหมวดหมู่ผลงานวิจัย', 'error');
      return;
    }
    // ตรวจสอบว่าอัปโหลดรูปภาพปกแล้ว
    if (!uploadedImageUrlInput.value) {
      showFormMessage('กรุณาอัปโหลดรูปภาพปกผลงานวิจัย', 'error');
      return;
    }
    // ตรวจสอบว่าอัปโหลดไฟล์ผลงานวิจัยแล้ว
    let researchFileUrls = [];
    try {
        researchFileUrls = JSON.parse(uploadedResearchFilesUrlInput.value || '[]');
    } catch (e) {
        showFormMessage('ข้อมูล URL ไฟล์ผลงานวิจัยไม่ถูกต้อง', 'error');
        return;
    }
    if (researchFileUrls.length === 0) {
      showFormMessage('กรุณาอัปโหลดไฟล์ผลงานวิจัย', 'error');
      return;
    }

    showFormMessage('กำลังส่งข้อมูล... กรุณารอสักครู่', 'info');
    document.getElementById('submit-btn').disabled = true;

    // รวบรวมข้อมูลทั้งหมดในรูปแบบ FormData
    const formData = new FormData();
    formData.append('action', 'submitResearch'); // บอก Apps Script ว่าจะทำอะไร
    formData.append('id', `res-${Date.now()}-${Math.floor(Math.random() * 1000)}`); // Unique ID
    formData.append('title', document.getElementById('title').value);
    formData.append('category', selectedCategoryInput.value);
    formData.append('department', document.getElementById('department').value);
    formData.append('field', document.getElementById('field').value);
    formData.append('year', document.getElementById('year').value);
    formData.append('academicYear', document.getElementById('academic-year').value);
    // แปลง Array ของ authors เป็น String ที่คั่นด้วยคอมมา
    formData.append('authors', Array.from(document.querySelectorAll('input[name="authors[]"]')).map(input => input.value).join(', '));
    formData.append('advisor', document.getElementById('advisor').value);
    formData.append('abstract', document.getElementById('abstract').value);
    formData.append('coverImageUrl', uploadedImageUrlInput.value); // URL ของรูปภาพปก
    formData.append('researchFileUrls', JSON.stringify(researchFileUrls)); // Array ของ URL ไฟล์ผลงานวิจัย (เก็บเป็น JSON string)
    formData.append('timestamp', new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })); // เพิ่ม Timestamp

    try {
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            body: formData, // ส่ง FormData
        });

        const result = await response.json();

        if (result.status === 'success') {
            showFormMessage('ส่งข้อมูลผลงานวิจัยสำเร็จแล้ว!', 'success');
            // ล้างฟอร์มทั้งหมด
            document.getElementById('research-form').reset();
            categoryItems.forEach(i => i.classList.remove('selected'));
            selectedCategoryInput.value = '';
            const authorsElements = authorsContainer.querySelectorAll('.author-entry');
            authorsElements.forEach((author, idx) => {
                if(idx > 0) author.remove(); // Keep only the first author input field
            });
            uploadedImageUrlInput.value = '';
            coverImagePreview.classList.add('hidden');
            imageUrlDisplay.textContent = '';
            uploadedResearchFilesUrlInput.value = '';
            researchFileListDiv.innerHTML = '';
            hideImageUploadMessage();
            hideFileUploadMessage();
        } else {
            showFormMessage(`เกิดข้อผิดพลาด: ${result.message || 'ไม่สามารถส่งข้อมูลได้'}`, 'error');
        }
    } catch (error) {
        console.error('Error submitting research to Google Apps Script:', error);
        showFormMessage('เกิดข้อผิดพลาดในการเชื่อมต่อกับ Apps Script', 'error');
    } finally {
        document.getElementById('submit-btn').disabled = false;
        // Optional: Reset form messages after a short delay
        setTimeout(() => {
            hideFormMessage();
        }, 5000); 
    }
  });
</script>

</body>
</html>
