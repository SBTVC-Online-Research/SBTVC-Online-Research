<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>อัปโหลดผลงานวิจัย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS ส่วนที่ใช้แสดงผลข้อความสถานะ */
        .message-box {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem; /* Tailwind's rounded-md */
            font-weight: 500;
        }
        .message-box.info {
            background-color: #bfdbfe; /* Tailwind's bg-blue-200 */
            color: #1e40af; /* Tailwind's text-blue-800 */
        }
        .message-box.success {
            background-color: #d1fae5; /* Tailwind's bg-green-200 */
            color: #065f46; /* Tailwind's text-green-800 */
        }
        .message-box.error {
            background-color: #fee2e2; /* Tailwind's bg-red-200 */
            color: #991b1b; /* Tailwind's text-red-800 */
        }
        .message-box.warning {
            background-color: #fef3c7; /* Tailwind's bg-yellow-200 */
            color: #92400e; /* Tailwind's text-yellow-800 */
        }
        .category-item.selected {
            @apply bg-blue-500 text-white; /* Tailwind classes */
        }
        .author-actions button {
            @apply ml-2 px-3 py-1 rounded-md text-sm;
        }
        .author-actions .add-author {
            @apply bg-green-500 text-white hover:bg-green-600;
        }
        .author-actions .remove-author {
            @apply bg-red-500 text-white hover:bg-red-600;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">อัปโหลดผลงานวิจัยใหม่</h1>
        
        <div id="form-message" class="message-box hidden" role="alert"></div>
        <div id="image-upload-message" class="message-box hidden" role="alert"></div>
        <div id="file-upload-message" class="message-box hidden" role="alert"></div>

        <form id="research-form" class="space-y-6">
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">ชื่อผลงานวิจัย <span class="text-red-500">*</span></label>
                <input type="text" id="title" name="title" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">หมวดหมู่ <span class="text-red-500">*</span></label>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <div class="category-item border border-gray-300 rounded-md p-3 text-center cursor-pointer hover:bg-gray-50 transition-colors" data-value="บทความวิจัย">บทความวิจัย</div>
                    <div class="category-item border border-gray-300 rounded-md p-3 text-center cursor-pointer hover:bg-gray-50 transition-colors" data-value="วิทยานิพนธ์">วิทยานิพนธ์</div>
                    <div class="category-item border border-gray-300 rounded-md p-3 text-center cursor-pointer hover:bg-gray-50 transition-colors" data-value="สารนิพนธ์">สารนิพนธ์</div>
                    <div class="category-item border border-gray-300 rounded-md p-3 text-center cursor-pointer hover:bg-gray-50 transition-colors" data-value="การศึกษาอิสระ">การศึกษาอิสระ</div>
                    <div class="category-item border border-gray-300 rounded-md p-3 text-center cursor-pointer hover:bg-gray-50 transition-colors" data-value="งานวิจัยรับจ้าง">งานวิจัยรับจ้าง</div>
                    <div class="category-item border border-gray-300 rounded-md p-3 text-center cursor-pointer hover:bg-gray-50 transition-colors" data-value="อื่นๆ">อื่นๆ</div>
                </div>
                <input type="hidden" id="selected-category" name="category" required>
            </div>

            <div>
                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">สาขา <span class="text-red-500">*</span></label>
                <input type="text" id="department" name="department" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <div>
                <label for="field" class="block text-sm font-medium text-gray-700 mb-1">กลุ่มวิชา/แขนงวิชา <span class="text-red-500">*</span></label>
                <input type="text" id="field" name="field" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="year" class="block text-sm font-medium text-gray-700 mb-1">ปีที่ทำ <span class="text-red-500">*</span></label>
                    <input type="number" id="year" name="year" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="academic-year" class="block text-sm font-medium text-gray-700 mb-1">ปีการศึกษา <span class="text-red-500">*</span></label>
                    <input type="text" id="academic-year" name="academicYear" placeholder="เช่น 2566/2567" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
            </div>

            <div>
                <label for="authors-container" class="block text-sm font-medium text-gray-700 mb-1">ผู้จัดทำ <span class="text-red-500">*</span></label>
                <div id="authors-container" class="space-y-2">
                    <div class="author-entry flex items-center">
                        <input type="text" name="authors[]" placeholder="ชื่อ-นามสกุล ผู้จัดทำ" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <div class="author-actions">
                            <button type="button" class="add-author bg-green-500 text-white px-3 py-1 rounded-md ml-2 text-sm hover:bg-green-600">เพิ่ม</button>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="advisor" class="block text-sm font-medium text-gray-700 mb-1">อาจารย์ที่ปรึกษา <span class="text-red-500">*</span></label>
                <input type="text" id="advisor" name="advisor" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <div>
                <label for="abstract" class="block text-sm font-medium text-gray-700 mb-1">บทคัดย่อ <span class="text-red-500">*</span></label>
                <textarea id="abstract" name="abstract" rows="5" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
            </div>

            <div>
                <label for="cover-image-input" class="block text-sm font-medium text-gray-700 mb-1">รูปภาพปกผลงานวิจัย <span class="text-red-500">*</span></label>
                <input type="file" id="cover-image-input" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <input type="hidden" id="uploaded-image-url" name="coverImageUrl">
                <div id="cover-image-preview" class="mt-4 hidden">
                    <img id="uploaded-image-display" src="" alt="Cover Image Preview" class="max-w-xs h-auto rounded-md shadow-md">
                    <p class="text-sm text-gray-600 mt-2">URL: <span id="image-url-display" class="break-all text-blue-700"></span></p>
                </div>
            </div>

            <div>
                <label for="research-file-input" class="block text-sm font-medium text-gray-700 mb-1">ไฟล์ผลงานวิจัย (.pdf, .doc, .docx, .ppt, .pptx) <span class="text-red-500">*</span></label>
                <input type="file" id="research-file-input" multiple accept=".pdf,.doc,.docx,.ppt,.pptx" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <input type="hidden" id="uploaded-research-files-url" name="researchFileUrls">
                <div id="research-file-list" class="mt-2 space-y-1">
                    </div>
            </div>

            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" id="cancel-btn" class="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    ยกเลิก
                </button>
                <button type="submit" id="submit-btn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" disabled>
                    ส่งข้อมูล
                </button>
            </div>
        </form>
    </div>

<script>
    // **สำคัญมาก: แทนที่ด้วย Web App URL ที่คุณ Deploy จาก Google Apps Script ของคุณ**
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-QTyfdSXqxmqVNoql7uRkoRZuGCHlZOJA-atzZT4ZEnIiLE_92v6dEm6iR3hBOzkp/exec'; 
    
    // Cloudinary Configuration (แทนที่ด้วย Cloud Name และ Preset ของคุณ)
    const CLOUDINARY_CLOUD_NAME = 'davuwvefc';
    const CLOUDINARY_UPLOAD_PRESET_IMAGE = 'STVC_preset'; // สำหรับรูปภาพปก
    const CLOUDINARY_UPLOAD_PRESET_FILES = 'STVC_preset'; // สำหรับไฟล์วิจัย (PDF, DOCX ฯลฯ)

    const formMessageDiv = document.getElementById('form-message');
    const imageUploadMessageDiv = document.getElementById('image-upload-message');
    const fileUploadMessageDiv = document.getElementById('file-upload-message');

    function showFormMessage(message, type = 'info') {
        formMessageDiv.textContent = message;
        formMessageDiv.className = `message-box ${type}`;
        formMessageDiv.classList.remove('hidden');
    }
    function hideFormMessage() {
        formMessageDiv.classList.add('hidden');
    }

    function showImageUploadMessage(message, type = 'info') {
        imageUploadMessageDiv.textContent = message;
        imageUploadMessageDiv.className = `message-box ${type}`;
        imageUploadMessageDiv.classList.remove('hidden');
    }
    function hideImageUploadMessage() {
        imageUploadMessageDiv.classList.add('hidden');
    }

    function showFileUploadMessage(message, type = 'info') {
        fileUploadMessageDiv.textContent = message;
        fileUploadMessageDiv.className = `message-box ${type}`;
        fileUploadMessageDiv.classList.remove('hidden');
    }
    function hideFileUploadMessage() {
        fileUploadMessageDiv.classList.add('hidden');
    }

    const categoryItems = document.querySelectorAll('.category-item');
    const selectedCategoryInput = document.getElementById('selected-category');
    const authorsContainer = document.getElementById('authors-container');
    const coverImageInput = document.getElementById('cover-image-input');
    const uploadedImageUrlInput = document.getElementById('uploaded-image-url');
    const coverImagePreview = document.getElementById('cover-image-preview');
    const uploadedImageDisplay = document.getElementById('uploaded-image-display');
    const imageUrlDisplay = document.getElementById('image-url-display');

    const researchFileInput = document.getElementById('research-file-input');
    const uploadedResearchFilesUrlInput = document.getElementById('uploaded-research-files-url');
    const researchFileListDiv = document.getElementById('research-file-list');

    let pendingFileUploads = 0; // ตัวนับไฟล์ที่กำลังอัปโหลด
    let uploadedImageInfo = null; // เก็บข้อมูลรูปภาพปกที่อัปโหลดแล้ว
    let uploadedFileInfos = []; // เก็บข้อมูลไฟล์วิจัยที่อัปโหลดแล้ว [{url: 'url', name: 'name', type: 'type'}]

    const submitButton = document.getElementById('submit-btn');

    // ฟังก์ชันตรวจสอบความถูกต้องของฟอร์ม
    function checkFormValidity() {
        const form = document.getElementById('research-form');
        const requiredInputs = form.querySelectorAll('[required]');
        let allRequiredFilled = true;

        requiredInputs.forEach(input => {
            if (input.type === 'hidden' && input.id === 'selected-category') {
                if (!input.value) { // Category must be selected
                    allRequiredFilled = false;
                }
            } else if (input.type === 'hidden' && input.id === 'uploaded-image-url') {
                if (!input.value) { // Cover image must be uploaded
                    allRequiredFilled = false;
                }
            } else if (input.type === 'hidden' && input.id === 'uploaded-research-files-url') {
                if (uploadedFileInfos.length === 0) { // At least one research file must be uploaded
                    allRequiredFilled = false;
                }
            } else if (input.tagName === 'TEXTAREA' || input.tagName === 'INPUT') {
                 if (input.value.trim() === '') {
                    allRequiredFilled = false;
                }
            }
        });

        // ตรวจสอบผู้จัดทำ
        const authorInputs = document.querySelectorAll('input[name="authors[]"]');
        let authorsFilled = false;
        if (authorInputs.length > 0) {
            authorsFilled = Array.from(authorInputs).every(input => input.value.trim() !== '');
        } else {
            authorsFilled = false; // ต้องมีอย่างน้อย 1 ผู้จัดทำ
        }
        
        // ถ้ามีไฟล์ที่กำลังอัปโหลดอยู่ ให้ปุ่มเป็น disabled
        if (pendingFileUploads > 0) {
            submitButton.disabled = true;
            return;
        }

        submitButton.disabled = !(allRequiredFilled && authorsFilled);
    }

    // Listener สำหรับฟิลด์ทั่วไป
    document.getElementById('research-form').addEventListener('input', checkFormValidity);

    // เลือกหมวดหมู่
    categoryItems.forEach(item => {
        item.addEventListener('click', () => {
            categoryItems.forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            selectedCategoryInput.value = item.dataset.value;
            checkFormValidity(); // ตรวจสอบสถานะฟอร์มเมื่อเลือกหมวดหมู่
        });
    });

    // เพิ่ม/ลบผู้จัดทำ
    function createAddButton() {
        const button = document.createElement('button');
        button.type = 'button';
        button.classList.add('add-author', 'bg-green-500', 'text-white', 'px-3', 'py-1', 'rounded-md', 'ml-2', 'text-sm', 'hover:bg-green-600');
        button.textContent = 'เพิ่ม';
        button.addEventListener('click', addAuthorField);
        return button;
    }

    function createRemoveButton() {
        const button = document.createElement('button');
        button.type = 'button';
        button.classList.add('remove-author', 'bg-red-500', 'text-white', 'px-3', 'py-1', 'rounded-md', 'ml-2', 'text-sm', 'hover:bg-red-600');
        button.textContent = 'ลบ';
        button.addEventListener('click', function() {
            this.closest('.author-entry').remove();
            checkAuthorButtons();
            checkFormValidity();
        });
        return button;
    }

    function addAuthorField() {
        const div = document.createElement('div');
        div.classList.add('author-entry', 'flex', 'items-center');
        div.innerHTML = `
            <input type="text" name="authors[]" placeholder="ชื่อ-นามสกุล ผู้จัดทำ" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            <div class="author-actions"></div>
        `;
        const actionsDiv = div.querySelector('.author-actions');
        actionsDiv.appendChild(createAddButton());
        actionsDiv.appendChild(createRemoveButton());
        authorsContainer.appendChild(div);
        checkAuthorButtons();
        checkFormValidity();
    }

    function checkAuthorButtons() {
        const authorEntries = authorsContainer.querySelectorAll('.author-entry');
        if (authorEntries.length === 1) {
            // ถ้ามีเพียงช่องเดียว ให้แสดงเฉพาะปุ่มเพิ่ม
            authorEntries[0].querySelector('.remove-author')?.remove();
            if (!authorEntries[0].querySelector('.add-author')) {
                authorEntries[0].querySelector('.author-actions').appendChild(createAddButton());
            }
        } else {
            // ถ้ามีมากกว่า 1 ช่อง ให้แสดงปุ่มเพิ่มสำหรับช่องสุดท้าย และปุ่มลบสำหรับทุกช่อง
            authorEntries.forEach((entry, index) => {
                const actionsDiv = entry.querySelector('.author-actions');
                
                // ลบปุ่มเดิมทั้งหมดก่อน
                actionsDiv.innerHTML = ''; 

                if (index === authorEntries.length - 1) {
                    actionsDiv.appendChild(createAddButton());
                }
                actionsDiv.appendChild(createRemoveButton());
            });
        }
    }

    // ตั้งค่าปุ่มผู้จัดทำเมื่อโหลดหน้าครั้งแรก
    document.addEventListener('DOMContentLoaded', checkAuthorButtons);

    // Upload Cover Image to Cloudinary
    coverImageInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) {
            uploadedImageUrlInput.value = '';
            coverImagePreview.classList.add('hidden');
            uploadedImageInfo = null;
            checkFormValidity();
            return;
        }

        if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET_IMAGE) {
            showImageUploadMessage('Cloudinary configuration missing. Please set CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET_IMAGE.', 'error');
            return;
        }

        showImageUploadMessage('กำลังอัปโหลดรูปภาพปก...', 'info');
        pendingFileUploads++;
        submitButton.disabled = true; // Disable submit button during upload

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET_IMAGE);

        try {
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData,
            });
            const data = await response.json();

            if (data.secure_url) {
                uploadedImageUrlInput.value = data.secure_url;
                uploadedImageDisplay.src = data.secure_url;
                imageUrlDisplay.textContent = data.secure_url;
                coverImagePreview.classList.remove('hidden');
                uploadedImageInfo = { url: data.secure_url, name: file.name, type: file.type };
                showImageUploadMessage('อัปโหลดรูปภาพปกสำเร็จ!', 'success');
            } else {
                uploadedImageUrlInput.value = '';
                coverImagePreview.classList.add('hidden');
                uploadedImageInfo = null;
                showImageUploadMessage(`อัปโหลดรูปภาพปกไม่สำเร็จ: ${data.error ? data.error.message : 'เกิดข้อผิดพลาดไม่ทราบสาเหตุ'}`, 'error');
                console.error('Cloudinary upload error:', data);
            }
        } catch (error) {
            uploadedImageUrlInput.value = '';
            coverImagePreview.classList.add('hidden');
            uploadedImageInfo = null;
            showImageUploadMessage(`อัปโหลดรูปภาพปกเกิดข้อผิดพลาด: ${error.message}`, 'error');
            console.error('Error uploading image to Cloudinary:', error);
        } finally {
            pendingFileUploads--;
            checkFormValidity(); // Re-check after upload
        }
    });

    // Upload Research Files to Cloudinary
    researchFileInput.addEventListener('change', async (event) => {
        const files = Array.from(event.target.files);
        if (files.length === 0) {
            uploadedResearchFilesUrlInput.value = JSON.stringify([]);
            researchFileListDiv.innerHTML = '';
            uploadedFileInfos = [];
            checkFormValidity();
            return;
        }

        if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET_FILES) {
            showFileUploadMessage('Cloudinary configuration missing for files. Please set CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET_FILES.', 'error');
            return;
        }

        uploadedFileInfos = []; // Reset previous files
        researchFileListDiv.innerHTML = ''; // Clear previous display
        showFileUploadMessage(`กำลังอัปโหลด ${files.length} ไฟล์...`, 'info');
        pendingFileUploads += files.length;
        submitButton.disabled = true; // Disable submit button during upload

        for (const file of files) {
            const fileItemDiv = document.createElement('div');
            fileItemDiv.classList.add('flex', 'items-center', 'justify-between', 'border', 'border-gray-200', 'p-2', 'rounded-md');
            fileItemDiv.innerHTML = `
                <span class="text-sm text-gray-700">${file.name}</span>
                <span class="text-sm text-gray-500" id="status-${file.name.replace(/\./g, '-')}-${file.size}">กำลังอัปโหลด...</span>
            `;
            researchFileListDiv.appendChild(fileItemDiv);

            const statusSpan = document.getElementById(`status-${file.name.replace(/\./g, '-')}-${file.size}`);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET_FILES);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/raw/upload`, { // Use /raw/upload for non-image files
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (data.secure_url) {
                    uploadedFileInfos.push({
                        url: data.secure_url,
                        name: file.name,
                        type: file.type
                    });
                    statusSpan.textContent = 'อัปโหลดสำเร็จ!';
                    statusSpan.classList.remove('text-gray-500');
                    statusSpan.classList.add('text-green-600');
                } else {
                    statusSpan.textContent = `อัปโหลดไม่สำเร็จ: ${data.error ? data.error.message : 'ข้อผิดพลาดไม่ทราบสาเหตุ'}`;
                    statusSpan.classList.remove('text-gray-500');
                    statusSpan.classList.add('text-red-600');
                    console.error('Cloudinary file upload error:', data);
                }
            } catch (error) {
                statusSpan.textContent = `อัปโหลดเกิดข้อผิดพลาด: ${error.message}`;
                statusSpan.classList.remove('text-gray-500');
                statusSpan.classList.add('text-red-600');
                console.error('Error uploading file to Cloudinary:', error);
            } finally {
                pendingFileUploads--;
                uploadedResearchFilesUrlInput.value = JSON.stringify(uploadedFileInfos); // Update hidden input
                checkFormValidity(); // Re-check after each file upload
                if (pendingFileUploads === 0) {
                    if (uploadedFileInfos.length === files.length) {
                        showFileUploadMessage('อัปโหลดไฟล์งานวิจัยทั้งหมดสำเร็จ!', 'success');
                    } else if (uploadedFileInfos.length > 0) {
                        showFileUploadMessage('อัปโหลดไฟล์งานวิจัยบางส่วนสำเร็จ มีบางไฟล์ล้มเหลว', 'warning');
                    } else {
                        showFileUploadMessage('อัปโหลดไฟล์งานวิจัยไม่สำเร็จเลย โปรดลองอีกครั้ง', 'error');
                    }
                }
            }
        }
    });


    // Submit Form
    document.getElementById('research-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        hideFormMessage();
        submitButton.disabled = true; // Disable submit button to prevent double submission
        submitButton.textContent = 'กำลังส่งข้อมูล...';

        if (pendingFileUploads > 0) {
            showFormMessage('กรุณารอการอัปโหลดไฟล์และรูปภาพให้เสร็จสิ้นก่อน!', 'warning');
            submitButton.disabled = false;
            submitButton.textContent = 'ส่งข้อมูล';
            return;
        }

        const formData = new FormData(event.target);
        const data = {};

        // Collect authors as a comma-separated string
        const authors = Array.from(document.querySelectorAll('input[name="authors[]"]'))
                             .map(input => input.value.trim())
                             .filter(value => value !== '');
        data.authors = authors.join(', '); // Join with comma and space

        // Collect other form fields
        formData.forEach((value, key) => {
            if (key !== 'authors[]') { // Exclude authors[] from direct formData processing
                data[key] = value;
            }
        });

        // Add dynamically generated fields
        data.id = `RES_${Date.now()}`; // Unique ID for research
        data.timestamp = new Date().toLocaleString('th-TH'); // Current timestamp
        
        // Ensure image URL is from our uploaded state, not directly from input (which might be empty if no re-upload)
        data.coverImageUrl = uploadedImageUrlInput.value;
        // Ensure research file URLs are from our uploaded state
        data.researchFileUrls = uploadedResearchFilesUrlInput.value; 

        // Get current logged-in username from sessionStorage
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        data.username = loggedInUser ? loggedInUser.username : 'anonymous'; // Set username

        try {
            const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data).toString(),
            });
            const result = await response.json();

            if (result.success) {
                showFormMessage('ส่งข้อมูลงานวิจัยสำเร็จ! ข้อมูลของคุณจะถูกตรวจสอบโดยผู้ดูแลระบบ.', 'success');
                document.getElementById('research-form').reset(); // Clear form
                // Clear all dynamic fields/previews
                selectedCategoryInput.value = '';
                categoryItems.forEach(i => i.classList.remove('selected'));
                authorsContainer.innerHTML = ''; // Clear authors
                addAuthorField(); // Add back one author field
                uploadedImageUrlInput.value = '';
                coverImagePreview.classList.add('hidden');
                uploadedImageInfo = null;
                researchFileInput.value = ''; // Clear file input
                uploadedResearchFilesUrlInput.value = JSON.stringify([]);
                researchFileListDiv.innerHTML = '';
                uploadedFileInfos = [];
            } else {
                showFormMessage(`ส่งข้อมูลไม่สำเร็จ: ${result.message}`, 'error');
            }
        } catch (error) {
            showFormMessage(`เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}`, 'error');
            console.error('Error submitting form:', error);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'ส่งข้อมูล';
            checkFormValidity(); // Re-check validity after submission attempt
        }
    });

    document.getElementById('cancel-btn').addEventListener('click', () => {
        // Optionally redirect or clear form
        if (confirm('คุณต้องการยกเลิกการอัปโหลดและล้างข้อมูลในฟอร์มใช่หรือไม่?')) {
            document.getElementById('research-form').reset();
            selectedCategoryInput.value = '';
            categoryItems.forEach(i => i.classList.remove('selected'));
            authorsContainer.innerHTML = '';
            addAuthorField(); // Add back one author field
            uploadedImageUrlInput.value = '';
            coverImagePreview.classList.add('hidden');
            uploadedImageInfo = null;
            researchFileInput.value = '';
            uploadedResearchFilesUrlInput.value = JSON.stringify([]);
            researchFileListDiv.innerHTML = '';
            uploadedFileInfos = [];
            hideFormMessage();
            hideImageUploadMessage();
            hideFileUploadMessage();
            pendingFileUploads = 0; // Reset pending uploads
            checkFormValidity();
        }
    });

    // เรียกใช้ checkFormValidity เมื่อโหลดหน้าครั้งแรก เพื่อตั้งค่าปุ่ม submit เริ่มต้น
    document.addEventListener('DOMContentLoaded', () => {
        addAuthorField(); // เพิ่มช่องผู้จัดทำเริ่มต้น
        checkFormValidity(); 
    });

</script>
</body>
</html>
