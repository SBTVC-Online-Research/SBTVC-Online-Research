<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายละเอียดงานวิจัย</title>
    <link rel="stylesheet" href="style.css"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* CSS เพิ่มเติมหรือปรับปรุงเล็กน้อยเพื่อการแสดงผล */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 960px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #0056b3;
            margin-bottom: 15px;
        }
        .research-detail p {
            margin-bottom: 8px;
        }
        .abstract-content, .objective-content, .benefit-content {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            white-space: pre-wrap; /* เพื่อรักษารูปแบบการขึ้นบรรทัดใหม่จากข้อมูล */
        }
        .file-links a {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            margin-right: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .file-links a:hover {
            background-color: #0056b3;
        }
        #loadingMessage, #errorMessage {
            padding: 20px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }
        #loadingMessage {
            color: #007bff;
        }
        #errorMessage {
            color: #dc3545;
        }
        .related-research {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .related-list a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        .related-list a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <header class="bg-dark text-white py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <h1>STBVC Online Research</h1>
            <nav>
                <a href="index.html" class="btn btn-primary">หน้าแรก</a>
                <a href="research-upload.html" class="btn btn-outline-light">อัปโหลดงานวิจัย</a>
                </nav>
        </div>
    </header>

    <main class="container mt-4">
        <section class="research-detail">
            <p id="loadingMessage" style="display: none;">กำลังโหลดข้อมูล...</p>
            <p id="errorMessage" style="display: none;">ไม่พบข้อมูลงานวิจัย หรือเกิดข้อผิดพลาดในการโหลด</p>

            <h1 id="researchTitleTH"></h1>
            <h2 id="researchTitleENG" class="text-muted fs-4"></h2>
            
            <p><strong>ผู้แต่ง:</strong> <span id="researchAuthors"></span></p>
            <p><strong>อาจารย์ที่ปรึกษา:</strong> <span id="researchAdvisor"></span></p>
            <p><strong>สาขางานวิจัย:</strong> <span id="researchField"></span></p>
            <p><strong>ประเภทงานวิจัย:</strong> <span id="researchCategory"></span></p>
            <p><strong>ปีที่เผยแพร่:</strong> <span id="researchYear"></span></p>
            <p><strong>ปีการศึกษา:</strong> <span id="researchAcademicYear"></span></p>
            
            <h3>บทคัดย่อ</h3>
            <div id="researchAbstract" class="abstract-content"></div>

            <h3>วัตถุประสงค์</h3>
            <div id="researchObjective" class="objective-content"></div>

            <h3>ประโยชน์ที่ได้รับ</h3>
            <div id="researchBenefit" class="benefit-content"></div>

            <h3>ไฟล์เอกสารและการอ้างอิง</h3>
            <div id="researchFiles" class="file-links">
                </div>
            <p><strong>การอ้างอิง:</strong> <span id="researchReference"></span></p>
            
        </section>

        <section class="related-research">
            <h2>งานวิจัยที่เกี่ยวข้อง</h2>
            <div class="related-list" id="relatedResearchList">
                <p>จะแสดงงานวิจัยที่เกี่ยวข้องที่นี่ (ยังไม่ได้นำข้อมูลมาใส่).</p>
                </div>
        </section>
    </main>

    <footer class="bg-dark text-white text-center py-3 mt-4">
        <p>&copy; 2024 STBVC Online Research. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // *** โค้ด JavaScript สำหรับดึงข้อมูลและแสดงผล ***
        document.addEventListener('DOMContentLoaded', function() {
            // URL ของ Google Apps Script Web App ของคุณ
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby-QTyfdSXqxmqVNoql7uRkoRZuGCHlZOJA-atzZT4ZEnIiLE_92v6dEm6iR3hBOzkp/exec';

            // ดึงค่า 'id' จาก URL Parameter (เช่น OnlineMMM.html?id=123)
            const params = new URLSearchParams(window.location.search);
            const researchId = params.get('id');

            // อ้างอิง Element ต่างๆ ใน HTML
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const researchDetailSection = document.querySelector('.research-detail'); 

            // ตรวจสอบว่ามี ID ใน URL หรือไม่
            if (!researchId) {
                researchDetailSection.style.display = 'none'; // ซ่อนส่วนรายละเอียด
                errorMessage.textContent = 'ไม่พบ ID งานวิจัยใน URL กรุณาระบุ ID ที่ถูกต้อง (เช่น ?id=1)';
                errorMessage.style.display = 'block';
                return;
            }

            // แสดงข้อความกำลังโหลด
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none'; // ซ่อนข้อความข้อผิดพลาด

            // ทำการ Fetch ข้อมูลจาก Google Apps Script Web App
            fetch(`${WEB_APP_URL}?id=${researchId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingMessage.style.display = 'none'; // ซ่อนข้อความกำลังโหลดเมื่อได้ข้อมูล

                    // ตรวจสอบว่า Apps Script ส่งข้อผิดพลาดกลับมาหรือไม่ หรือข้อมูลว่างเปล่า
                    if (data.status === 'error' || !data || Object.keys(data).length === 0) {
                        researchDetailSection.style.display = 'none';
                        errorMessage.textContent = 'ไม่พบข้อมูลงานวิจัยสำหรับ ID นี้ หรือเกิดข้อผิดพลาดในการโหลดข้อมูล';
                        errorMessage.style.display = 'block';
                        return;
                    }

                    // ข้อมูลงานวิจัยที่ได้มา (เป็น Object เดียว)
                    const research = data;

                    // กรอกข้อมูลลงใน Element ต่างๆ ใน HTML
                    document.getElementById('researchTitleTH').textContent = research.Title || 'ไม่มีชื่อเรื่อง (ไทย)';
                    // ใช้ Department หรือ Category มาแสดงในชื่อเรื่อง ENG ถ้าไม่มี Title Eng
                    document.getElementById('researchTitleENG').textContent = research.Department || research.Category || 'ไม่มีข้อมูลเพิ่มเติม';

                    document.getElementById('researchAuthors').textContent = research.Authors || 'ไม่ระบุ';
                    document.getElementById('researchAdvisor').textContent = research.Advisor || 'ไม่ระบุ';
                    document.getElementById('researchField').textContent = research.Field || 'ไม่ระบุ';
                    document.getElementById('researchCategory').textContent = research.Category || 'ไม่ระบุ';
                    document.getElementById('researchYear').textContent = research.Year || 'ไม่ระบุ';
                    document.getElementById('researchAcademicYear').textContent = research['Academic Year'] || 'ไม่ระบุ';
                    
                    // แสดง Abstract พร้อมขึ้นบรรทัดใหม่จาก \n
                    document.getElementById('researchAbstract').innerHTML = research.Abstract ? research.Abstract.replace(/\n/g, '<br>') : 'ไม่มีบทคัดย่อ';
                    
                    // แสดง Objective และ Benefit (สมมติว่ามีคอลัมน์เหล่านี้ใน Google Sheet)
                    document.getElementById('researchObjective').innerHTML = research.Objective ? research.Objective.replace(/\n/g, '<br>') : 'ยังไม่มีข้อมูลวัตถุประสงค์';
                    document.getElementById('researchBenefit').innerHTML = research.Benefit ? research.Benefit.replace(/\n/g, '<br>') : 'ยังไม่มีข้อมูลประโยชน์ที่ได้รับ';

                    // จัดการลิงก์ไฟล์เอกสาร (Research File URLs)
                    const researchFilesDiv = document.getElementById('researchFiles');
                    researchFilesDiv.innerHTML = ''; // เคลียร์เนื้อหาเก่าออก

                    if (research['Research File URLs']) {
                        try {
                            // พยายาม Parse JSON string เป็น Array
                            const fileUrls = JSON.parse(research['Research File URLs']);
                            if (Array.isArray(fileUrls) && fileUrls.length > 0) {
                                fileUrls.forEach(url => {
                                    if (url) {
                                        const link = document.createElement('a');
                                        link.href = url;
                                        link.target = '_blank'; // เปิดในแท็บใหม่
                                        let linkText = 'ดาวน์โหลดเอกสาร';
                                        // ปรับข้อความลิงก์ตามประเภทไฟล์
                                        if (url.toLowerCase().includes('.pdf')) {
                                            linkText = 'ดาวน์โหลด PDF';
                                        } else if (url.toLowerCase().includes('.pptx') || url.toLowerCase().includes('.ppt')) {
                                            linkText = 'ดาวน์โหลด PPTX';
                                        } else if (url.toLowerCase().includes('abstract')) { // ตัวอย่างการระบุลิงก์บทคัดย่อ
                                            linkText = 'ลิงก์บทคัดย่อ';
                                        }
                                        link.textContent = linkText;
                                        link.classList.add('button', 'download-button'); // เพิ่มคลาสสำหรับจัดสไตล์
                                        researchFilesDiv.appendChild(link);
                                        researchFilesDiv.appendChild(document.createElement('br')); // ขึ้นบรรทัดใหม่
                                    }
                                });
                            } else if (typeof fileUrls === 'string' && fileUrls) { // กรณีมีแค่ URL เดียวที่ไม่ได้อยู่ใน Array
                                const link = document.createElement('a');
                                link.href = fileUrls;
                                link.target = '_blank';
                                link.textContent = 'ดาวน์โหลดเอกสาร';
                                link.classList.add('button', 'download-button');
                                researchFilesDiv.appendChild(link);
                            }
                        } catch (e) {
                            console.error('Error parsing Research File URLs:', e);
                            researchFilesDiv.innerHTML = '<p>เกิดข้อผิดพลาดในการแสดงลิงก์เอกสาร</p>';
                        }
                    } else {
                        researchFilesDiv.innerHTML = '<p>ไม่มีไฟล์เอกสารสำหรับการดาวน์โหลด</p>';
                    }

                    document.getElementById('researchReference').textContent = research.Reference || 'ไม่มีข้อมูลการอ้างอิง';

                    // แสดงส่วนรายละเอียดหลังจากโหลดข้อมูลสำเร็จ
                    researchDetailSection.style.display = 'block';

                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    loadingMessage.style.display = 'none';
                    researchDetailSection.style.display = 'none';
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}`;
                    errorMessage.style.display = 'block';
                });

            // ส่วนของ "งานวิจัยที่เกี่ยวข้อง" (Related Research)
            // โค้ดส่วนนี้ยังเป็นโครงสร้างและตัวอย่างเท่านั้น
            // เพื่อดึงข้อมูลงานวิจัยที่เกี่ยวข้อง คุณจะต้องตัดสินใจว่าจะดึงจากเกณฑ์ใด
            // เช่น ดึงจาก Category, Field หรือ Authors เดียวกัน
            // และคุณอาจจะต้องเรียกใช้ Apps Script API อีกครั้งเพื่อดึงข้อมูลทั้งหมด
            // แล้วค่อยมา Filter หรือจะสร้าง API แยกสำหรับ Related Research โดยเฉพาะก็ได้
            // ตัวอย่างโค้ดที่ถูกคอมเมนต์ไว้ในบทสนทนาก่อนหน้า เป็นแนวทางเริ่มต้น
            // เมื่อคุณพร้อมที่จะพัฒนาส่วนนี้ สามารถแจ้งผมได้เลยครับ
        });
    </script>
</body>
</html>
